<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÊàëÁöÑÈìæÊé•</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîó</text></svg>">
  <style>
    :root {
      --bg-body: #f8f9fa;
      --bg-card: #ffffff;
      --text-main: #212529;
      --text-secondary: #6c757d;
      --border-color: #dee2e6;
      --primary-color: #007bff;
      --primary-hover-color: #0056b3;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --input-bg: #fff;
      --input-border: #ced4da;
      --shadow-light: rgba(0, 0, 0, 0.05);
      --shadow-medium: rgba(0, 0, 0, 0.1);
      --highlight-bg: #e2f0ff;
      --category-active-bg: #e9ecef;
      --category-active-border: #007bff;
    }

    [data-theme='dark'] {
      --bg-body: #1a1a1a;
      --bg-card: #2c2c2c;
      --text-main: #e0e0e0;
      --text-secondary: #b0b0b0;
      --border-color: #444444;
      --primary-color: #6a9cff;
      --primary-hover-color: #4a7cdd;
      --success-color: #4caf50;
      --danger-color: #ff6b6b;
      --input-bg: #3a3a3a;
      --input-border: #555555;
      --shadow-light: rgba(0, 0, 0, 0.2);
      --shadow-medium: rgba(0, 0, 0, 0.3);
      --highlight-bg: #2b3d57;
      --category-active-bg: #3d3d3d;
      --category-active-border: #6a9cff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      line-height: 1.6;
      color: var(--text-main);
      background-color: var(--bg-body);
      transition: background-color 0.3s, color 0.3s;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .container {
      max-width: 96rem;
      width: 100%;
      margin: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 1.25rem;
      flex-grow: 1;
    }

    /* ‰æßËæπÊ†èÊ†∑Âºè */
    .sidebar {
      flex: 0 0 16rem;
      /* Âõ∫ÂÆöÂÆΩÂ∫¶ */
      background-color: var(--bg-card);
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.125rem 0.25rem var(--shadow-light);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      height: fit-content;
      /* ËÆ©‰æßËæπÊ†èÈ´òÂ∫¶ÈÄÇÂ∫îÂÜÖÂÆπ */
      position: sticky;
      /* Á≤òÊÄßÂÆö‰Ωç */
      top: 1.25rem;
      /* Ë∑ùÁ¶ªÈ°∂ÈÉ®1.25rem */
    }

    .sidebar h3 {
      font-size: 1.125rem;
      margin-bottom: 0.5rem;
      color: var(--text-main);
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar li {
      margin-bottom: 0.5rem;
    }

    .sidebar a,
    .sidebar button {
      display: block;
      width: 100%;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      color: var(--text-main);
      text-decoration: none;
      background-color: transparent;
      border: 1px solid transparent;
      text-align: left;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
      font-size: 0.9375rem;
    }

    .sidebar a:hover,
    .sidebar button:hover {
      background-color: var(--bg-body);
    }

    .sidebar a.active,
    .sidebar button.active {
      background-color: var(--category-active-bg);
      border-color: var(--category-active-border);
      color: var(--primary-color);
      font-weight: bold;
    }

    .sidebar .search-input,
    .sidebar .add-category-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--input-border);
      border-radius: 0.375rem;
      background-color: var(--input-bg);
      color: var(--text-main);
      font-size: 0.9375rem;
      margin-bottom: 0.5rem;
    }

    .sidebar .add-category-btn {
      background-color: var(--success-color);
      color: #fff;
      border: none;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      cursor: pointer;
      width: 100%;
      font-size: 0.9375rem;
      transition: background-color 0.2s;
    }

    .sidebar .add-category-btn:hover {
      background-color: #218838;
    }

    .sidebar .category-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }

    .sidebar .category-actions button {
      flex-grow: 1;
      font-size: 0.875rem;
      padding: 0.3rem 0.5rem;
      border: none;
      border-radius: 0.25rem;
      cursor: pointer;
      color: #fff;
    }

    .sidebar .category-actions .edit-btn {
      background-color: var(--primary-color);
    }

    .sidebar .category-actions .edit-btn:hover {
      background-color: var(--primary-hover-color);
    }

    .sidebar .category-actions .delete-btn {
      background-color: var(--danger-color);
    }

    .sidebar .category-actions .delete-btn:hover {
      background-color: #c82333;
    }

    .sidebar .category-actions .save-btn {
      background-color: var(--success-color);
    }

    .sidebar .category-actions .save-btn:hover {
      background-color: #218838;
    }

    .sidebar .category-actions .cancel-btn {
      background-color: var(--text-secondary);
    }

    .sidebar .category-actions .cancel-btn:hover {
      background-color: #5a6268;
    }

    /* ‰∏ªÂÜÖÂÆπÂå∫ÂüüÊ†∑Âºè */
    .main-content {
      flex: 1;
      min-width: 0;
      /* Allow content to shrink */
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .header-actions {
      background-color: var(--bg-card);
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.125rem 0.25rem var(--shadow-light);
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .header-actions .search-input {
      flex: 1;
      min-width: 10rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--input-border);
      border-radius: 0.375rem;
      background-color: var(--input-bg);
      color: var(--text-main);
      font-size: 0.9375rem;
    }

    .header-actions button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.9375rem;
      transition: background-color 0.2s;
    }

    .header-actions .add-link-btn {
      background-color: var(--primary-color);
      color: #fff;
    }

    .header-actions .add-link-btn:hover {
      background-color: var(--primary-hover-color);
    }

    .header-actions .theme-toggle-btn {
      background-color: var(--text-secondary);
      color: #fff;
    }

    .header-actions .theme-toggle-btn:hover {
      background-color: #5a6268;
    }

    .header-actions .current-category-title {
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--primary-color);
      margin-right: auto;
      /* Push other items to the right */
    }

    /* Ê±âÂ†°ËèúÂçïÊ†∑Âºè */
    .hamburger-menu-container {
      position: relative;
      /* Áî®‰∫éÂÆö‰Ωç‰∏ãÊãâËèúÂçï */
      margin-left: 0.75rem;
      /* ‰∏éÂÖ∂‰ªñÊåâÈíÆÁöÑÈó¥Èöî */
      display: flex;
      align-items: center;
    }

    .hamburger-icon {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      width: 2rem;
      height: 2rem;
      background: var(--primary-color);
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      padding: 0.4rem;
      box-sizing: border-box;
      transition: background-color 0.2s;
    }

    .hamburger-icon:hover {
      background-color: var(--primary-hover-color);
    }

    .hamburger-icon .line {
      width: 100%;
      height: 0.2rem;
      background-color: #fff;
      border-radius: 0.125rem;
      transition: all 0.2s ease-in-out;
    }

    /* ‰∏ãÊãâËèúÂçïÊ†∑Âºè */
    .dropdown-menu {
      position: absolute;
      top: 100%;
      /* ‰Ωç‰∫éÊ±âÂ†°ÂõæÊ†á‰∏ãÊñπ */
      right: 0;
      /* ÂØπÈΩêÂè≥‰æß */
      background-color: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      box-shadow: 0 0.25rem 0.5rem var(--shadow-medium);
      min-width: 10rem;
      padding: 0.5rem 0;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-0.625rem);
      transition: opacity 0.2s ease-out, visibility 0.2s ease-out, transform 0.2s ease-out;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .dropdown-menu.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-menu .nav-item {
      display: block;
      padding: 0.5rem 1rem;
      color: var(--text-main);
      text-decoration: none;
      white-space: nowrap;
      transition: background-color 0.2s;
    }

    .dropdown-menu .nav-item:hover {
      background-color: var(--bg-body);
    }

    .links-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(18rem, 1fr));
      gap: 1.25rem;
      flex-grow: 1;
    }

    .link-card {
      background-color: var(--bg-card);
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.125rem 0.25rem var(--shadow-light);
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border-color);
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: grab;
      /* Indicate draggable */
    }

    .link-card:active {
      cursor: grabbing;
    }

    .link-card.dragging {
      opacity: 0.5;
      box-shadow: 0 0.5rem 1rem var(--shadow-medium);
    }

    .link-card.drag-over {
      border: 2px dashed var(--primary-color);
    }

    .link-card h4 {
      font-size: 1.125rem;
      margin-bottom: 0.5rem;
      color: var(--primary-color);
    }

    .link-card p {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
      flex-grow: 1;
      /* Pushes button to bottom */
    }

    .link-card .link-url {
      display: block;
      color: var(--primary-color);
      text-decoration: none;
      word-break: break-all;
      margin-bottom: 0.75rem;
      font-size: 0.9375rem;
    }

    .link-card .link-url:hover {
      text-decoration: underline;
    }

    .link-card .actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .link-card .actions button {
      padding: 0.4rem 0.75rem;
      border: none;
      border-radius: 0.25rem;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background-color 0.2s;
      color: #fff;
    }

    .link-card .actions .edit-btn {
      background-color: var(--primary-color);
    }

    .link-card .actions .edit-btn:hover {
      background-color: var(--primary-hover-color);
    }

    .link-card .actions .delete-btn {
      background-color: var(--danger-color);
    }

    .link-card .actions .delete-btn:hover {
      background-color: #c82333;
    }

    /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .modal-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .modal-box {
      background-color: var(--bg-card);
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.5rem 1rem var(--shadow-medium);
      width: 90%;
      max-width: 30rem;
      color: var(--text-main);
      transform: translateY(-1.25rem);
      transition: transform 0.3s;
      position: relative;
    }

    .modal-overlay.open .modal-box {
      transform: translateY(0);
    }

    .modal-title {
      font-size: 1.375rem;
      margin-bottom: 1.25rem;
      color: var(--primary-color);
    }

    .modal-form label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
      font-size: 0.9375rem;
    }

    .modal-form input[type="text"],
    .modal-form input[type="url"],
    .modal-form textarea,
    .modal-form select {
      width: 100%;
      padding: 0.625rem;
      margin-bottom: 1rem;
      border: 1px solid var(--input-border);
      border-radius: 0.375rem;
      background-color: var(--input-bg);
      color: var(--text-main);
      font-size: 0.9375rem;
    }

    .modal-form textarea {
      resize: vertical;
      min-height: 5rem;
    }

    .modal-form .checkbox-group {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      font-size: 0.9375rem;
    }

    .modal-form .checkbox-group input[type="checkbox"] {
      margin-right: 0.5rem;
      width: auto;
      margin-bottom: 0;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .modal-actions button {
      padding: 0.625rem 1.25rem;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.9375rem;
      transition: background-color 0.2s;
    }

    .modal-actions .save-btn {
      background-color: var(--primary-color);
      color: #fff;
    }

    .modal-actions .save-btn:hover {
      background-color: var(--primary-hover-color);
    }

    .modal-actions .cancel-btn {
      background-color: var(--border-color);
      color: var(--text-main);
    }

    .modal-actions .cancel-btn:hover {
      background-color: #d1d7dc;
    }

    [data-theme='dark'] .modal-actions .cancel-btn {
      background-color: #555555;
      color: #e0e0e0;
    }

    [data-theme='dark'] .modal-actions .cancel-btn:hover {
      background-color: #666666;
    }

    /* Â∫ïÈÉ®ÂØºËà™Êàñ‰ø°ÊÅØ */
    .footer {
      margin-top: 2rem;
      text-align: center;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* ÂìçÂ∫îÂºèËÆæËÆ° */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      .sidebar {
        flex: none;
        /* Remove fixed width */
        width: 100%;
        /* Take full width */
        position: static;
        /* Remove sticky on mobile */
        margin-bottom: 1.25rem;
      }

      .header-actions {
        /* Adjust header actions to accommodate hamburger menu better on small screens */
        flex-wrap: wrap;
        justify-content: space-between;
      }

      .header-actions .search-input {
        width: 100%;
        margin-bottom: 0.5rem;
      }

      .header-actions .current-category-title {
        margin-right: 0;
        margin-bottom: 0.5rem;
        text-align: center;
        margin-bottom: 1rem;
      }

      .header-actions button {
        width: 100%;
      }

      .hamburger-menu-container {
        order: 3;
        /* Hamburger menu last */
        margin-left: auto;
        /* Push to right */
      }

      .dropdown-menu {
        left: auto;
        right: 0;
        /* Align right on small screens */
      }

      .links-grid {
        grid-template-columns: 1fr;
        /* Single column on mobile */
      }
    }
  </style>
</head>

<body>
  <script src="/@public/theme.js"></script>
  <script src="/@public/nav.js"></script>

  <div class="container">
    <!-- ‰æßËæπÊ†è - ÂàÜÁ±ªÂàóË°® -->
    <aside class="sidebar">
      <h3>ÈìæÊé•ÂàÜÁ±ª</h3>
      <input type="text" id="categorySearchInput" class="search-input" placeholder="ÊêúÁ¥¢ÂàÜÁ±ª...">
      <ul id="categoryList" class="category-list">
        <!-- ÂàÜÁ±ªÈ°πÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÂä†ËΩΩ -->
      </ul>
      <div class="add-category-section">
        <input type="text" id="newCategoryName" class="add-category-input" placeholder="Êñ∞ÂàÜÁ±ªÂêçÁß∞">
        <button id="addCategoryBtn" class="add-category-btn">Ê∑ªÂä†ÂàÜÁ±ª</button>
      </div>
    </aside>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü - ÈìæÊé•ÂàóË°® -->
    <main class="main-content">
      <div class="header-actions">
        <h2 id="currentCategoryTitle" class="current-category-title">ÊâÄÊúâÈìæÊé•</h2>
        <input type="text" id="linkSearchInput" class="search-input" placeholder="ÊêúÁ¥¢ÈìæÊé•Ê†áÈ¢òÊàñÊèèËø∞...">
        <button id="addLinkBtn" class="add-link-btn">Ê∑ªÂä†ÈìæÊé•</button>
        <button class="theme-toggle-btn" data-action="open-theme-modal">‰∏ªÈ¢òËÆæÁΩÆ <span
            id="currentThemeText"></span></button>
        <div class="hamburger-menu-container">
          <button id="hamburgerIcon" class="hamburger-icon">
            <span class="line"></span>
            <span class="line"></span>
            <span class="line"></span>
          </button>
          <div id="dropdownNavMenu" class="dropdown-menu">
            <!-- Nav items will be rendered here by JS -->
          </div>
        </div>
      </div>
      <div id="linksGrid" class="links-grid">
        <!-- ÈìæÊé•Âç°ÁâáÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÂä†ËΩΩ -->
      </div>
    </main>
  </div>

  <!-- ÈìæÊé•Ê∑ªÂä†/ÁºñËæëÊ®°ÊÄÅÊ°Ü -->
  <div id="linkModalOverlay" class="modal-overlay">
    <div class="modal-box">
      <h3 class="modal-title" id="linkModalTitle">Ê∑ªÂä†ÈìæÊé•</h3>
      <form id="linkForm" class="modal-form">
        <input type="hidden" id="linkId">
        <label for="linkTitle">Ê†áÈ¢ò:</label>
        <input type="text" id="linkTitle" required>

        <label for="linkUrl">URL:</label>
        <input type="url" id="linkUrl" required>

        <label for="linkDescription">ÊèèËø∞:</label>
        <textarea id="linkDescription"></textarea>

        <label for="linkCategory">ÂàÜÁ±ª:</label>
        <select id="linkCategory">
          <!-- ÂàÜÁ±ªÈÄâÈ°πÈÄöËøáJSÂä®ÊÄÅÂ°´ÂÖÖ -->
        </select>

        <div class="checkbox-group">
          <input type="checkbox" id="linkIsPublic">
          <label for="linkIsPublic">ÂÖ¨ÂºÄÂèØËßÅ</label>
        </div>

        <div class="modal-actions">
          <button type="submit" class="save-btn">‰øùÂ≠ò</button>
          <button type="button" class="cancel-btn" id="cancelLinkModalBtn">ÂèñÊ∂à</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ÂàÜÁ±ªÁºñËæëÊ®°ÊÄÅÊ°Ü -->
  <div id="categoryModalOverlay" class="modal-overlay">
    <div class="modal-box">
      <h3 class="modal-title" id="categoryModalTitle">ÁºñËæëÂàÜÁ±ª</h3>
      <form id="categoryForm" class="modal-form">
        <input type="hidden" id="categoryId">
        <label for="categoryName">ÂêçÁß∞:</label>
        <input type="text" id="categoryName" required>

        <div class="checkbox-group">
          <input type="checkbox" id="categoryIsPublic">
          <label for="categoryIsPublic">ÂÖ¨ÂºÄÂèØËßÅ</label>
        </div>

        <div class="modal-actions">
          <button type="submit" class="save-btn">‰øùÂ≠ò</button>
          <button type="button" class="cancel-btn" id="cancelCategoryModalBtn">ÂèñÊ∂à</button>
        </div>
      </form>
    </div>
  </div>


  <script>
    const API_BASE = '/@links/api/';
    let categories = [];
    let links = [];
    let currentCategoryID = 0; // 0 for "All Links"
    let publicMode = false; // Whether currently viewing public links

    // --- Â∑•ÂÖ∑ÂáΩÊï∞ ---
    async function fetchData(url, options = {}) {
      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! Status: ${response.status}, Message: ${errorText}`);
        }
        return await response.json();
      } catch (error) {
        console.error("Fetch error:", error);
        alert("ËØ∑Ê±ÇÂ§±Ë¥•: " + error.message);
        throw error;
      }
    }

    function debounce(func, delay) {
      let timeout;
      return function (...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
      };
    }

    // --- ÂàÜÁ±ªÁÆ°ÁêÜ ---
    async function loadCategories(isPublic = false) {
      const url = `${API_BASE}categories${isPublic ? '?public=1' : ''}`;
      categories = await fetchData(url);
      renderCategories();
    }

    function renderCategories() {
      const categoryList = document.getElementById('categoryList');
      categoryList.innerHTML = ''; // Ê∏ÖÁ©∫Áé∞ÊúâÂàÜÁ±ª

      // Ê∑ªÂä†‚ÄúÊâÄÊúâÈìæÊé•‚ÄùÈÄâÈ°π
      const allLinksItem = document.createElement('li');
      const allLinksBtn = document.createElement('button');
      allLinksBtn.textContent = 'ÊâÄÊúâÈìæÊé•';
      allLinksBtn.dataset.id = 0;
      allLinksBtn.classList.add('category-btn');
      if (currentCategoryID === 0 && !publicMode) {
        allLinksBtn.classList.add('active');
      }
      allLinksBtn.addEventListener('click', () => selectCategory(0, false));
      allLinksItem.appendChild(allLinksBtn);
      categoryList.appendChild(allLinksItem);

      // Ê∑ªÂä†‚ÄúÂÖ¨ÂÖ±ÈìæÊé•‚ÄùÈÄâÈ°π
      const publicLinksItem = document.createElement('li');
      const publicLinksBtn = document.createElement('button');
      publicLinksBtn.textContent = 'ÂÖ¨ÂºÄÈìæÊé•';
      publicLinksBtn.dataset.id = -1; // Áî®-1Ë°®Á§∫ÂÖ¨ÂÖ±ÈìæÊé•
      publicLinksBtn.classList.add('category-btn');
      if (publicMode) {
        publicLinksBtn.classList.add('active');
      }
      publicLinksBtn.addEventListener('click', () => selectCategory(-1, true));
      publicLinksItem.appendChild(publicLinksBtn);
      categoryList.appendChild(publicLinksItem);


      // Ê∏≤ÊüìÂÖ∂‰ªñÂàÜÁ±ª
      categories.forEach(category => {
        const li = document.createElement('li');
        li.setAttribute('draggable', true);
        li.dataset.id = category.id;
        li.dataset.sortNum = category.sort_num;

        const button = document.createElement('button');
        button.textContent = category.name + (category.is_public ? ' (ÂÖ¨ÂºÄ)' : '');
        button.dataset.id = category.id;
        button.classList.add('category-btn');
        if (currentCategoryID === category.id && !publicMode) {
          button.classList.add('active');
        }
        button.addEventListener('click', () => selectCategory(category.id, false));

        const actionsDiv = document.createElement('div');
        actionsDiv.classList.add('category-actions');

        const editBtn = document.createElement('button');
        editBtn.textContent = 'ÁºñËæë';
        editBtn.classList.add('edit-btn');
        editBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // ÈòªÊ≠¢ÁÇπÂáªÂàÜÁ±ªÊåâÈíÆ
          openCategoryModal(category);
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Âà†Èô§';
        deleteBtn.classList.add('delete-btn');
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteCategory(category.id);
        });

        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);

        li.appendChild(button);
        if (!publicMode) { // ÈùûÂÖ¨ÂºÄÊ®°ÂºèÊâçÊòæÁ§∫ÁºñËæë/Âà†Èô§ÊåâÈíÆ
          li.appendChild(actionsDiv);
        }

        categoryList.appendChild(li);
      });
      setupCategoryDragAndDrop();
    }

    function selectCategory(id, isPublic = false) {
      currentCategoryID = id;
      publicMode = isPublic;
      const categoryTitleElement = document.getElementById('currentCategoryTitle');
      if (isPublic) {
        categoryTitleElement.textContent = 'ÂÖ¨ÂºÄÈìæÊé•';
      } else if (id === 0) {
        categoryTitleElement.textContent = 'ÊâÄÊúâÈìæÊé•';
      } else {
        const selectedCategory = categories.find(cat => cat.id === id);
        categoryTitleElement.textContent = selectedCategory ? selectedCategory.name : 'ÊâÄÊúâÈìæÊé•';
      }
      // Êõ¥Êñ∞ÂàÜÁ±ªÂàóË°®ÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
      document.querySelectorAll('.category-btn').forEach(btn => {
        if (parseInt(btn.dataset.id) === id && !isPublic) {
          btn.classList.add('active');
        } else if (parseInt(btn.dataset.id) === -1 && isPublic) {
          btn.classList.add('active');
        }
        else {
          btn.classList.remove('active');
        }
      });
      loadLinks(id, isPublic);
      renderCategories(); // ÈáçÊñ∞Ê∏≤ÊüìÂàÜÁ±ªÂàóË°®‰ª•ÊòæÁ§∫ÁºñËæë/Âà†Èô§ÊåâÈíÆÁöÑÂèØËßÅÊÄß
    }

    async function addCategory() {
      const nameInput = document.getElementById('newCategoryName');
      const name = nameInput.value.trim();
      if (!name) {
        alert('ÂàÜÁ±ªÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫');
        return;
      }
      try {
        const newCategory = await fetchData(`${API_BASE}categories`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({name: name, sort_num: 0, is_public: false})
        });
        categories.push(newCategory);
        nameInput.value = '';
        await loadCategories(); // ÈáçÊñ∞Âä†ËΩΩÂπ∂Ê∏≤Êüì
      } catch (error) {
        console.error('Ê∑ªÂä†ÂàÜÁ±ªÂ§±Ë¥•:', error);
      }
    }

    async function deleteCategory(id) {
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§ÂàÜÁ±ªÂêóÔºüÂÖ≥ËÅîÁöÑÈìæÊé•‰∏ç‰ºöË¢´Âà†Èô§Ôºå‰ΩÜ‰ºöÂ§±ÂéªÂàÜÁ±ª„ÄÇ')) return;
      try {
        await fetchData(`${API_BASE}categories?id=${id}`, {method: 'DELETE'});
        await loadCategories();
        // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÂàÜÁ±ªÔºåÂàôÂàáÊç¢Âà∞‚ÄúÊâÄÊúâÈìæÊé•‚Äù
        if (currentCategoryID === id) {
          selectCategory(0, false);
        }
      } catch (error) {
        console.error('Âà†Èô§ÂàÜÁ±ªÂ§±Ë¥•:', error);
      }
    }

    // ÂàÜÁ±ªÁºñËæëÊ®°ÊÄÅÊ°Ü
    const categoryModalOverlay = document.getElementById('categoryModalOverlay');
    const categoryForm = document.getElementById('categoryForm');
    const categoryIdInput = document.getElementById('categoryId');
    const categoryNameInput = document.getElementById('categoryName');
    const categoryIsPublicInput = document.getElementById('categoryIsPublic');
    const categoryModalTitle = document.getElementById('categoryModalTitle');
    const cancelCategoryModalBtn = document.getElementById('cancelCategoryModalBtn');

    function openCategoryModal(category = null) {
      if (category) {
        categoryIdInput.value = category.id;
        categoryNameInput.value = category.name;
        categoryIsPublicInput.checked = category.is_public;
        categoryModalTitle.textContent = 'ÁºñËæëÂàÜÁ±ª';
      } else {
        // ‰∏çÊîØÊåÅÁõ¥Êé•Ê∑ªÂä†ÔºåÊ∑ªÂä†Áî®‰æßËæπÊ†èÁöÑËæìÂÖ•Ê°Ü
        return;
      }
      categoryModalOverlay.classList.add('open');
    }

    function closeCategoryModal() {
      categoryModalOverlay.classList.remove('open');
      categoryForm.reset();
    }

    categoryForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = parseInt(categoryIdInput.value);
      const name = categoryNameInput.value.trim();
      const is_public = categoryIsPublicInput.checked;

      if (!name) {
        alert('ÂàÜÁ±ªÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫');
        return;
      }

      try {
        await fetchData(`${API_BASE}categories`, {
          method: 'POST', // ÂêéÁ´ØPOSTÁî®‰∫éÊñ∞Â¢ûÊàñÊõ¥Êñ∞ÔºåÊ†πÊçÆIDÂà§Êñ≠
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({id: id, name: name, is_public: is_public})
        });
        closeCategoryModal();
        await loadCategories(); // ÈáçÊñ∞Âä†ËΩΩÂπ∂Ê∏≤ÊüìÂàÜÁ±ª
        loadLinks(currentCategoryID, publicMode); // ÈáçÊñ∞Âä†ËΩΩÈìæÊé•
      } catch (error) {
        console.error('‰øùÂ≠òÂàÜÁ±ªÂ§±Ë¥•:', error);
      }
    });

    cancelCategoryModalBtn.addEventListener('click', closeCategoryModal);
    categoryModalOverlay.addEventListener('click', (e) => {
      if (e.target === categoryModalOverlay) {
        closeCategoryModal();
      }
    });

    // ÂàÜÁ±ªÊãñÊãΩÊéíÂ∫è
    let draggedCategory = null;

    function setupCategoryDragAndDrop() {
      const categoryItems = document.querySelectorAll('#categoryList > li[draggable="true"]');
      categoryItems.forEach(item => {
        item.addEventListener('dragstart', (e) => {
          draggedCategory = item;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', item.dataset.id);
          setTimeout(() => item.classList.add('dragging'), 0);
        });

        item.addEventListener('dragenter', (e) => {
          e.preventDefault();
          item.classList.add('drag-over');
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        });

        item.addEventListener('dragleave', () => {
          item.classList.remove('drag-over');
        });

        item.addEventListener('drop', (e) => {
          e.preventDefault();
          item.classList.remove('drag-over');
          if (draggedCategory && draggedCategory !== item) {
            const draggedIndex = Array.from(categoryList.children).indexOf(draggedCategory);
            const targetIndex = Array.from(categoryList.children).indexOf(item);

            if (draggedIndex < targetIndex) {
              categoryList.insertBefore(draggedCategory, item.nextSibling);
            } else {
              categoryList.insertBefore(draggedCategory, item);
            }
            updateCategorySortOrder();
          }
        });

        item.addEventListener('dragend', () => {
          draggedCategory.classList.remove('dragging');
          document.querySelectorAll('.category-list li').forEach(el => el.classList.remove('drag-over'));
          draggedCategory = null;
        });
      });
    }

    async function updateCategorySortOrder() {
      const sortedItems = Array.from(document.querySelectorAll('#categoryList > li[draggable="true"]'));
      const sortData = sortedItems.map((item, index) => ({
        id: parseInt(item.dataset.id),
        sort_num: sortedItems.length - index // ÁÆÄÂçïÂÄíÂ∫èÔºåÁ°Æ‰øùË∂äÈù†ÂâçÁöÑsort_numË∂äÂ§ß
      }));

      try {
        await fetchData(`${API_BASE}categories/sort`, {
          method: 'PATCH',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(sortData)
        });
        console.log('ÂàÜÁ±ªÊéíÂ∫èÊõ¥Êñ∞ÊàêÂäü');
        await loadCategories(); // ÈáçÊñ∞Âä†ËΩΩ‰ª•Á°Æ‰øùÊï∞ÊçÆÂêåÊ≠•
      } catch (error) {
        console.error('Êõ¥Êñ∞ÂàÜÁ±ªÊéíÂ∫èÂ§±Ë¥•:', error);
      }
    }


    // --- ÈìæÊé•ÁÆ°ÁêÜ ---
    async function loadLinks(categoryID = 0, isPublic = false) {
      let url = `${API_BASE}links`;
      const params = [];
      if (categoryID > 0) {
        params.push(`category_id=${categoryID}`);
      }
      if (isPublic) {
        params.push('public=1');
      }
      if (params.length > 0) {
        url += `?${params.join('&')}`;
      }

      links = await fetchData(url);
      filterAndRenderLinks(); // Initial render and filter
    }

    function renderLinks(filteredLinks) {
      const linksGrid = document.getElementById('linksGrid');
      linksGrid.innerHTML = '';
      if (filteredLinks.length === 0) {
        linksGrid.innerHTML = '<p style="text-align: center; color: var(--text-secondary); width: 100%;">Ê≤°ÊúâÊâæÂà∞ÈìæÊé•„ÄÇ</p>';
        return;
      }

      filteredLinks.forEach(link => {
        const card = document.createElement('div');
        card.classList.add('link-card');
        card.setAttribute('draggable', true);
        card.dataset.id = link.id;
        card.dataset.sortNum = link.sort_num;

        card.innerHTML = `
                    <h4>${link.title}</h4>
                    <a href="${link.url}" target="_blank" class="link-url">${link.url}</a>
                    <p>${link.description || 'Êó†ÊèèËø∞'}</p>
                    <div class="actions">
                        <button class="edit-btn" data-id="${link.id}">ÁºñËæë</button>
                        <button class="delete-btn" data-id="${link.id}">Âà†Èô§</button>
                    </div>
                `;
        linksGrid.appendChild(card);
      });

      // ÁªëÂÆöÁºñËæë/Âà†Èô§‰∫ã‰ª∂
      linksGrid.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const linkId = parseInt(e.target.dataset.id);
          const linkToEdit = links.find(l => l.id === linkId);
          if (linkToEdit) openLinkModal(linkToEdit);
        });
      });
      linksGrid.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const linkId = parseInt(e.target.dataset.id);
          deleteLink(linkId);
        });
      });
      setupLinkDragAndDrop();
    }

    function filterAndRenderLinks() {
      const searchInput = document.getElementById('linkSearchInput');
      const searchTerm = searchInput.value.toLowerCase();
      const filteredLinks = links.filter(link =>
        link.title.toLowerCase().includes(searchTerm) ||
        link.description.toLowerCase().includes(searchTerm)
      );
      renderLinks(filteredLinks);
    }

    // ÈìæÊé•Ê∑ªÂä†/ÁºñËæëÊ®°ÊÄÅÊ°Ü
    const linkModalOverlay = document.getElementById('linkModalOverlay');
    const linkForm = document.getElementById('linkForm');
    const linkIdInput = document.getElementById('linkId');
    const linkTitleInput = document.getElementById('linkTitle');
    const linkUrlInput = document.getElementById('linkUrl');
    const linkDescriptionInput = document.getElementById('linkDescription');
    const linkCategorySelect = document.getElementById('linkCategory');
    const linkIsPublicInput = document.getElementById('linkIsPublic');
    const linkModalTitle = document.getElementById('linkModalTitle');
    const cancelLinkModalBtn = document.getElementById('cancelLinkModalBtn');

    function openLinkModal(link = null) {
      // Â°´ÂÖÖÂàÜÁ±ªÈÄâÈ°π
      linkCategorySelect.innerHTML = '<option value="0">Êó†ÂàÜÁ±ª</option>';
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        linkCategorySelect.appendChild(option);
      });

      if (link) {
        linkIdInput.value = link.id;
        linkTitleInput.value = link.title;
        linkUrlInput.value = link.url;
        linkDescriptionInput.value = link.description;
        linkCategorySelect.value = link.category_id || 0;
        linkIsPublicInput.checked = link.is_public;
        linkModalTitle.textContent = 'ÁºñËæëÈìæÊé•';
      } else {
        linkIdInput.value = '';
        linkForm.reset();
        linkCategorySelect.value = currentCategoryID > 0 ? currentCategoryID : 0; // ÈªòËÆ§ÈÄâÊã©ÂΩìÂâçÂàÜÁ±ª
        linkModalTitle.textContent = 'Ê∑ªÂä†ÈìæÊé•';
      }
      linkModalOverlay.classList.add('open');
    }

    function closeLinkModal() {
      linkModalOverlay.classList.remove('open');
      linkForm.reset();
    }

    linkForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = linkIdInput.value ? parseInt(linkIdInput.value) : 0;
      const title = linkTitleInput.value.trim();
      const url = linkUrlInput.value.trim();
      const description = linkDescriptionInput.value.trim();
      const category_id = parseInt(linkCategorySelect.value) || 0;
      const is_public = linkIsPublicInput.checked;

      if (!title || !url) {
        alert('Ê†áÈ¢òÂíåURL‰∏çËÉΩ‰∏∫Á©∫');
        return;
      }

      const linkData = {
        id: id,
        title: title,
        url: url,
        description: description,
        category_id: category_id,
        is_public: is_public,
        sort_num: 0 // Êñ∞Â¢ûÊó∂ÈªòËÆ§ÊéíÂ∫è
      };

      try {
        await fetchData(`${API_BASE}link`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(linkData)
        });
        closeLinkModal();
        await loadLinks(currentCategoryID, publicMode); // ÈáçÊñ∞Âä†ËΩΩÂπ∂Ê∏≤ÊüìÈìæÊé•
      } catch (error) {
        console.error('‰øùÂ≠òÈìæÊé•Â§±Ë¥•:', error);
      }
    });

    cancelLinkModalBtn.addEventListener('click', closeLinkModal);
    linkModalOverlay.addEventListener('click', (e) => {
      if (e.target === linkModalOverlay) {
        closeLinkModal();
      }
    });

    async function deleteLink(id) {
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§ÈìæÊé•ÂêóÔºü')) return;
      try {
        await fetchData(`${API_BASE}link?id=${id}`, {method: 'DELETE'});
        await loadLinks(currentCategoryID, publicMode); // ÈáçÊñ∞Âä†ËΩΩÂπ∂Ê∏≤ÊüìÈìæÊé•
      } catch (error) {
        console.error('Âà†Èô§ÈìæÊé•Â§±Ë¥•:', error);
      }
    }

    // ÈìæÊé•ÊãñÊãΩÊéíÂ∫è
    let draggedLink = null;
    const linksGrid = document.getElementById('linksGrid');

    function setupLinkDragAndDrop() {
      const linkCards = document.querySelectorAll('.link-card');
      linkCards.forEach(card => {
        card.addEventListener('dragstart', (e) => {
          draggedLink = card;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', card.dataset.id);
          setTimeout(() => card.classList.add('dragging'), 0);
        });

        card.addEventListener('dragenter', (e) => {
          e.preventDefault();
          if (card !== draggedLink) {
            card.classList.add('drag-over');
          }
        });

        card.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (card !== draggedLink) {
            e.dataTransfer.dropEffect = 'move';
          }
        });

        card.addEventListener('dragleave', () => {
          card.classList.remove('drag-over');
        });

        card.addEventListener('drop', (e) => {
          e.preventDefault();
          card.classList.remove('drag-over');
          if (draggedLink && draggedLink !== card) {
            const draggedIndex = Array.from(linksGrid.children).indexOf(draggedLink);
            const targetIndex = Array.from(linksGrid.children).indexOf(card);

            if (draggedIndex < targetIndex) {
              linksGrid.insertBefore(draggedLink, card.nextSibling);
            } else {
              linksGrid.insertBefore(draggedLink, card);
            }
            updateLinkSortOrder();
          }
        });

        card.addEventListener('dragend', () => {
          draggedLink.classList.remove('dragging');
          document.querySelectorAll('.link-card').forEach(el => el.classList.remove('drag-over'));
          draggedLink = null;
        });
      });
    }

    async function updateLinkSortOrder() {
      const sortedItems = Array.from(document.querySelectorAll('.link-card'));
      const sortData = sortedItems.map((item, index) => ({
        id: parseInt(item.dataset.id),
        sort_num: sortedItems.length - index // ÁÆÄÂçïÂÄíÂ∫èÔºåÁ°Æ‰øùË∂äÈù†ÂâçÁöÑsort_numË∂äÂ§ß
      }));

      try {
        await fetchData(`${API_BASE}links/sort`, {
          method: 'PATCH',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(sortData)
        });
        console.log('ÈìæÊé•ÊéíÂ∫èÊõ¥Êñ∞ÊàêÂäü');
        await loadLinks(currentCategoryID, publicMode); // ÈáçÊñ∞Âä†ËΩΩ‰ª•Á°Æ‰øùÊï∞ÊçÆÂêåÊ≠•
      } catch (error) {
        console.error('Êõ¥Êñ∞ÈìæÊé•ÊéíÂ∫èÂ§±Ë¥•:', error);
      }
    }


    // --- ÂàùÂßãÂåñÂíå‰∫ã‰ª∂ÁªëÂÆö ---
    document.addEventListener('DOMContentLoaded', async () => {
      // ÂàùÂßãÂåñÂä†ËΩΩÊï∞ÊçÆ
      await loadCategories();
      await loadLinks(currentCategoryID, publicMode);
      renderNavigationMenu(); // Ê∏≤ÊüìÂØºËà™ËèúÂçï

      // ÊêúÁ¥¢ËæìÂÖ•Ê°Ü‰∫ã‰ª∂
      document.getElementById('linkSearchInput').addEventListener('input', debounce(filterAndRenderLinks, 300));
      document.getElementById('categorySearchInput').addEventListener('input', debounce(() => {
        const searchTerm = document.getElementById('categorySearchInput').value.toLowerCase();
        document.querySelectorAll('#categoryList li[draggable="true"]').forEach(li => {
          const categoryName = li.querySelector('button').textContent.toLowerCase();
          if (categoryName.includes(searchTerm)) {
            li.style.display = '';
          } else {
            li.style.display = 'none';
          }
        });
      }, 300));


      // Ê∑ªÂä†ÈìæÊé•ÊåâÈíÆ
      document.getElementById('addLinkBtn').addEventListener('click', () => openLinkModal());
      // Ê∑ªÂä†ÂàÜÁ±ªÊåâÈíÆ
      document.getElementById('addCategoryBtn').addEventListener('click', addCategory);

      // ÂàùÂßãÈÄâÊã©‚ÄúÊâÄÊúâÈìæÊé•‚Äù
      selectCategory(0, false);
      // ÁªëÂÆö‰∏ªÈ¢òËÆæÁΩÆÊåâÈíÆ
      if (window.bindThemeButton) {
        window.bindThemeButton();
      }
    });

    // --- ÂØºËà™ËèúÂçïÊ∏≤Êüì ---
    function renderNavigationMenu() {
      const hamburgerIcon = document.getElementById('hamburgerIcon');
      const dropdownNavMenu = document.getElementById('dropdownNavMenu');
      dropdownNavMenu.innerHTML = ''; // Ê∏ÖÁ©∫Áé∞ÊúâÂÜÖÂÆπ

      if (window.GlobalNavMenu) {
        const isLoggedIn = window.isLoggedIn ? window.isLoggedIn() : false;

        window.GlobalNavMenu.forEach(item => {
          // Ê†πÊçÆÁôªÂΩïÁä∂ÊÄÅËøáÊª§ÂØºËà™È°π
          if (item.onlyWhenNotLogin && isLoggedIn) {
            return;
          }
          if (item.onlyWhenLogin && !isLoggedIn) {
            return;
          }

          const link = document.createElement('a');
          link.href = item.url;
          link.textContent = item.name;
          link.classList.add('nav-item'); // ‰ΩøÁî®Êñ∞ÁöÑclass for dropdown items

          // Â¶ÇÊûúÊòØÈÄÄÂá∫ÊåâÈíÆÔºå‰ΩøÁî®ÂÆö‰πâÁöÑÂáΩÊï∞
          if (item.key === 'logout') {
            link.href = 'javascript:void(0)'; // Èò≤Ê≠¢È°µÈù¢Ë∑≥ËΩ¨
            link.addEventListener('click', (e) => {
              e.preventDefault(); // Prevent default link behavior
              if (window.logoutAndRedirect) {
                window.logoutAndRedirect();
                // Close menu after action
                dropdownNavMenu.classList.remove('open');
              }
            });
          } else {
            // For other links, close menu on click
            link.addEventListener('click', () => {
              dropdownNavMenu.classList.remove('open');
            });
          }

          dropdownNavMenu.appendChild(link);
        });
      }

      // Ê±âÂ†°ÂõæÊ†áÁÇπÂáª‰∫ã‰ª∂
      hamburgerIcon.addEventListener('click', (e) => {
        e.stopPropagation(); // Èò≤Ê≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞documentÔºåÁ´ãÂç≥ÂÖ≥Èó≠
        dropdownNavMenu.classList.toggle('open');
      });

      // ÁÇπÂáªÊñáÊ°£ÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
      document.addEventListener('click', (e) => {
        if (!hamburgerIcon.contains(e.target) && !dropdownNavMenu.contains(e.target)) {
          dropdownNavMenu.classList.remove('open');
        }
      });
    }

  </script>
</body>

</html>
