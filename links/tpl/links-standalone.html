<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÊàëÁöÑÈìæÊé•</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîó</text></svg>">
  <style>
    :root {
      --bg-body: #f8f9fa;
      --bg-card: #ffffff;
      --text-main: #212529;
      --text-secondary: #6c757d;
      --border-color: #dee2e6;
      --primary-color: #007bff;
      --primary-hover-color: #0056b3;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --input-bg: #fff;
      --input-border: #ced4da;
      --shadow-light: rgba(0, 0, 0, 0.05);
      --shadow-medium: rgba(0, 0, 0, 0.1);
      --highlight-bg: #e2f0ff;
      --category-active-bg: #e9ecef;
      --category-active-border: #007bff;
    }

    [data-theme='dark'] {
      --bg-body: #1a1a1a;
      --bg-card: #2c2c2c;
      --text-main: #e0e0e0;
      --text-secondary: #b0b0b0;
      --border-color: #444444;
      --primary-color: #6a9cff;
      --primary-hover-color: #4a7cdd;
      --success-color: #4caf50;
      --danger-color: #ff6b6b;
      --input-bg: #3a3a3a;
      --input-border: #555555;
      --shadow-light: rgba(0, 0, 0, 0.2);
      --shadow-medium: rgba(0, 0, 0, 0.3);
      --highlight-bg: #2b3d57;
      --category-active-bg: #3d3d3d;
      --category-active-border: #6a9cff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      line-height: 1.6;
      color: var(--text-main);
      background-color: var(--bg-body);
      transition: background-color 0.3s, color 0.3s;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .container {
      max-width: 96rem;
      width: 100%;
      margin: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 1.25rem;
      flex-grow: 1;
    }

    /* ‰æßËæπÊ†èÊ†∑Âºè */
    .sidebar {
      flex: 0 0 16rem;
      /* Âõ∫ÂÆöÂÆΩÂ∫¶ */
      background-color: var(--bg-card);
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.125rem 0.25rem var(--shadow-light);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      height: fit-content;
      /* ËÆ©‰æßËæπÊ†èÈ´òÂ∫¶ÈÄÇÂ∫îÂÜÖÂÆπ */
      position: sticky;
      /* Á≤òÊÄßÂÆö‰Ωç */
      top: 1.25rem;
      /* Ë∑ùÁ¶ªÈ°∂ÈÉ®1.25rem */
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      /* Space out title and button */
      margin-bottom: 0.5rem;
    }

    .sidebar h3 {
      font-size: 1.125rem;
      color: var(--text-main);
      margin-bottom: 0;
      /* Reset margin */
      flex-grow: 1;
      /* Allow title to take space */
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar li {
      margin-bottom: 0.15rem;
      /* Even tighter spacing */
      display: flex;
      /* Make it a flex container */
      align-items: center;
      position: relative;
      /* For icon positioning */
    }

    .sidebar a,
    .sidebar button.category-btn {
      /* Target category buttons specifically */
      display: block;
      flex-grow: 1;
      /* Allow it to take available space */
      padding: 0.3rem 0.5rem;
      /* Even smaller padding */
      border-radius: 0.375rem;
      color: var(--text-main);
      text-decoration: none;
      background-color: transparent;
      border: 1px solid transparent;
      /* Keep for active state */
      text-align: left;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
      font-size: 0.85rem;
      /* Even smaller font */
      white-space: nowrap;
      /* Prevent wrap */
      overflow: hidden;
      text-overflow: ellipsis;
      /* Add ellipsis */
    }

    .sidebar a:hover,
    .sidebar button:hover {
      background-color: var(--bg-body);
    }

    .sidebar a.active,
    .sidebar button.active {
      background-color: var(--category-active-bg);
      border-color: var(--category-active-border);
      color: var(--primary-color);
      font-weight: bold;
    }

    .sidebar .search-input,
    .sidebar .add-category-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--input-border);
      border-radius: 0.375rem;
      background-color: var(--input-bg);
      color: var(--text-main);
      font-size: 0.9375rem;
      margin-bottom: 0.5rem;
    }

    /* .add-category-btn removed, replaced by .add-icon-btn */

    .sidebar .category-actions {
      display: none;
      /* Permanently hide these buttons */
      gap: 0.25rem;
      /* Smaller gap */
      margin-left: auto;
      /* Push to the right */
      flex-shrink: 0;
    }

    .sidebar .category-actions button {
      flex-grow: 1;
      font-size: 0.75rem;
      /* Smaller font for buttons */
      padding: 0.2rem 0.4rem;
      /* Smaller padding */
      border: none;
      border-radius: 0.25rem;
      cursor: pointer;
      color: #fff;
      width: auto;
      /* Allow buttons to size naturally */
    }

    .sidebar .category-actions .edit-btn {
      background-color: var(--primary-color);
    }

    .sidebar .category-actions .edit-btn:hover {
      background-color: var(--primary-hover-color);
    }

    .sidebar .category-actions .delete-btn {
      background-color: var(--danger-color);
    }

    .sidebar .category-actions .delete-btn:hover {
      background-color: #c82333;
    }

    .sidebar .category-actions .save-btn {
      background-color: var(--success-color);
    }

    .sidebar .category-actions .save-btn:hover {
      background-color: #218838;
    }

    .sidebar .category-actions .cancel-btn {
      background-color: var(--text-secondary);
    }

    .sidebar .category-actions .cancel-btn:hover {
      background-color: #5a6268;
    }

    /* ‰∏ªÂÜÖÂÆπÂå∫ÂüüÊ†∑Âºè */
    .main-content {
      flex: 1;
      min-width: 0;
      /* Allow content to shrink */
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    /* New styles for sidebar edit mode */
    .sidebar.edit-mode .category-actions {
      display: none;
      /* Hide in edit mode as well, moving to modal */
    }

    .sidebar .category-action-icon {
      display: none;
      /* ÈªòËÆ§ÈöêËóè */
      margin-left: auto;
      /* Push icon to the right within the flex container */
      cursor: grab;
      /* ÊåáÁ§∫ÂèØÊãñÂä® */
      padding: 0.25rem 0.75rem;
      /* Increased padding for better hit area */
      font-size: 1.2rem;
      /* Make icon larger */
      color: var(--text-secondary);
      /* Default color */
      border-radius: 0.2rem;
      /* Consistent with link action icon */
      transition: background-color 0.2s, color 0.2s;
    }

    .sidebar .category-action-icon:hover {
      background-color: var(--hover-bg);
      /* Highlight on hover */
      color: var(--primary-color);
      /* Change color on hover */
    }

    /* ÁºñËæëÊ®°Âºè‰∏ãÊòæÁ§∫ category-action-icon */
    .sidebar.edit-mode .category-action-icon {
      display: inline-block;
    }

    .link-card .action-icon {
      width: 1.5rem;
      /* Increased size for easier grab */
      height: 1.5rem;
      /* Increased size for easier grab */
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-left: 0.2rem;
      flex-shrink: 0;
      color: var(--text-secondary);
      border-radius: 0.2rem;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s;
      font-weight: normal;
      font-size: 1rem;
      /* Increased font size for icon */
      border: 1px solid transparent;
    }

    .link-card .action-icon:hover {
      background-color: var(--bg-body);
      color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .link-card.edit-mode .action-icon {
      cursor: grab;
      border: 1px solid var(--border-color);
    }

    /* Tooltip for description */
    .link-card .description-tooltip {
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--card-bg-darker);
      color: var(--text-color-light);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      white-space: pre-wrap;
      z-index: 10;
      opacity: 0;
      visibility: hidden;
      /* Ensure it's hidden by default */
      transition: opacity 0.3s ease, visibility 0.3s ease;
      box-shadow: var(--shadow-small);
      max-width: 200px;
      text-align: center;
    }

    [data-theme='dark'] .link-card .description-tooltip {
      background-color: #fff;
      color: #333;
    }

    .link-card .description-tooltip.show {
      opacity: 1;
      visibility: visible;
    }

    /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .modal-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .modal-box {
      background-color: var(--bg-card);
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.5rem 1rem var(--shadow-medium);
      width: 90%;
      max-width: 30rem;
      color: var(--text-main);
      transform: translateY(-1.25rem);
      transition: transform 0.3s;
      position: relative;
    }

    .modal-overlay.open .modal-box {
      transform: translateY(0);
    }

    .modal-title {
      font-size: 1.375rem;
      margin-bottom: 1.25rem;
      color: var(--primary-color);
    }

    .modal-form label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
      font-size: 0.9375rem;
    }

    .modal-form input[type="text"],
    .modal-form input[type="url"],
    .modal-form textarea,
    .modal-form select {
      width: 100%;
      padding: 0.625rem;
      margin-bottom: 1rem;
      border: 1px solid var(--input-border);
      border-radius: 0.375rem;
      background-color: var(--input-bg);
      color: var(--text-main);
      font-size: 0.9375rem;
    }

    .modal-form textarea {
      resize: vertical;
      min-height: 5rem;
    }

    .modal-form .checkbox-group {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      font-size: 0.9375rem;
    }

    .modal-form .checkbox-group input[type="checkbox"] {
      margin-right: 0.5rem;
      width: auto;
      margin-bottom: 0;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .modal-actions button {
      padding: 0.625rem 1.25rem;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.9375rem;
      transition: background-color 0.2s;
    }

    .modal-actions .save-btn {
      background-color: var(--primary-color);
      color: #fff;
    }

    .modal-actions .save-btn:hover {
      background-color: var(--primary-hover-color);
    }

    .modal-actions .cancel-btn {
      background-color: var(--border-color);
      color: var(--text-main);
    }

    .modal-actions .cancel-btn:hover {
      background-color: #d1d7dc;
    }

    [data-theme='dark'] .modal-actions .cancel-btn {
      background-color: #555555;
      color: #e0e0e0;
    }

    [data-theme='dark'] .modal-actions .cancel-btn:hover {
      background-color: #666666;
    }

    .danger-btn-modal {
      background-color: var(--danger-color);
      color: #fff;
    }

    .danger-btn-modal:hover {
      background-color: #c82333;
    }

    /* Â∫ïÈÉ®ÂØºËà™Êàñ‰ø°ÊÅØ */
    .footer {
      margin-top: 2rem;
      text-align: center;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* È°∂ÈÉ®Êìç‰ΩúÊ†è header-actions Ê†∑Âºè */
    .header-actions {
      background-color: var(--bg-card);
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.125rem 0.25rem var(--shadow-light);
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    .header-actions .search-input {
      flex: 1;
      min-width: 10rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--input-border);
      border-radius: 0.375rem;
      background-color: var(--input-bg);
      color: var(--text-main);
      font-size: 0.9375rem;
    }

    .header-actions button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.9375rem;
      transition: background-color 0.2s;
      background-color: var(--primary-color);
      color: #fff;
    }

    .header-actions .add-link-btn {
      background-color: var(--primary-color);
    }

    .header-actions .add-link-btn:hover,
    .header-actions .add-icon-btn:hover {
      background-color: var(--primary-hover-color);
    }

    .header-actions .theme-toggle-btn {
      background-color: var(--text-secondary);
      color: #fff;
    }

    .header-actions .theme-toggle-btn:hover {
      background-color: #5a6268;
    }

    .header-actions .current-category-title {
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--primary-color);
      margin-right: auto;
    }

    /* Hamburger Menu and Dropdown */
    .hamburger-menu-container {
      position: relative;
      display: inline-block;
      margin-left: 1rem;
    }

    .hamburger-icon {
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 0.375rem;
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      width: 2.5rem;
      height: 2.2rem;
      align-items: center;
    }

    .hamburger-icon .line {
      width: 100%;
      height: 2px;
      background-color: #fff;
      transition: all 0.3s ease;
    }

    /* Dropdown Menu */
    .dropdown-menu {
      position: absolute;
      top: calc(100% + 10px);
      /* Position below the button with some spacing */
      right: 0;
      /* Align to the right of the button */
      background-color: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      box-shadow: var(--shadow-medium);
      min-width: 150px;
      z-index: 1000;
      /* Ensure it's above other content */
      padding: 0.5rem 0;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: opacity 0.2s ease-out, visibility 0.2s ease-out, transform 0.2s ease-out;
    }

    .dropdown-menu.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-menu a {
      display: block;
      padding: 0.5rem 1rem;
      color: var(--text-main);
      text-decoration: none;
      white-space: nowrap;
      transition: background-color 0.15s ease-in-out;
    }

    .dropdown-menu a:hover {
      background-color: var(--primary-color);
      color: #fff;
    }

    /* ÂìçÂ∫îÂºè header-actions */
    @media (max-width: 768px) {
      .header-actions {
        flex-direction: column;
        gap: 0.5rem;
        align-items: stretch;
      }

      .header-actions .current-category-title {
        margin-right: 0;
        margin-bottom: 0.5rem;
        text-align: center;
      }

      .header-actions button,
      .header-actions .search-input {
        width: 100%;
      }
    }

    /* linksGrid Âå∫ÂüüÊ†∑Âºè */
    .links-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(12rem, 1fr));
      gap: 0.75rem;
      flex-grow: 1;
      width: 100%;
      margin-top: 0.5rem;
    }

    .link-card {
      background-color: var(--bg-card);
      padding: 0.3rem 0.5rem;
      border-radius: 0.375rem;
      box-shadow: 0 0.0625rem 0.125rem var(--shadow-light);
      display: flex;
      align-items: center;
      gap: 0.25rem;
      border: 1px solid var(--border-color);
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
      overflow: visible;
      height: 2.2rem;
    }

    .link-card:active {
      cursor: grabbing;
    }

    .link-card.dragging {
      opacity: 0.5;
      box-shadow: 0 0.25rem 0.5rem var(--shadow-medium);
    }

    .link-card.drag-over {
      border: 2px dashed var(--primary-color);
    }

    .link-card h4 {
      font-size: 0.85rem;
      margin-bottom: 0;
      color: var(--primary-color);
      flex-grow: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }

    .link-card .link-url {
      display: flex;
      align-items: center;
      flex-grow: 1;
      color: var(--text-main);
      text-decoration: none;
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }

    .link-card .link-url:hover {
      text-decoration: underline;
    }

    /* ÂìçÂ∫îÂºè links-grid */
    @media (max-width: 768px) {
      .links-grid {
        grid-template-columns: 1fr;
      }

      .link-card {
        width: 100%;
        min-width: 0;
      }
    }
  </style>
</head>

<body>
  <script src="/@public/theme.js"></script>
  <script src="/@public/nav.js"></script>

  <div class="container">
    <!-- ‰æßËæπÊ†è - ÂàÜÁ±ªÂàóË°® -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h3>ÈìæÊé•ÂàÜÁ±ª</h3>
        <button id="addCategoryBtn" class="add-icon-btn" style="display: none;">+</button>
      </div>
      <ul id="categoryList" class="category-list">
        <!-- ÂàÜÁ±ªÈ°πÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÂä†ËΩΩ -->
      </ul>
      <!-- Old add-category-section is removed -->
    </aside>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü - ÈìæÊé•ÂàóË°® -->
    <main class="main-content">
      <div class="header-actions">
        <h2 id="currentCategoryTitle" class="current-category-title">ÊâÄÊúâÈìæÊé•</h2>
        <input type="text" id="linkSearchInput" class="search-input" placeholder="ÊêúÁ¥¢ÈìæÊé•Ê†áÈ¢òÊàñÊèèËø∞...">
        <button id="addLinkBtn" class="add-icon-btn" style="display: none;">+</button>
        <button id="toggleEditModeBtn" class="add-link-btn" style="display: none;">ËøõÂÖ•ÁºñËæëÊ®°Âºè</button>
        <button class="theme-toggle-btn" data-action="open-theme-modal">‰∏ªÈ¢òËÆæÁΩÆ <span
            id="currentThemeText"></span></button>
        <div class="hamburger-menu-container">
          <button id="hamburgerIcon" class="hamburger-icon">
            <span class="line"></span>
            <span class="line"></span>
            <span class="line"></span>
          </button>
          <div id="dropdownNavMenu" class="dropdown-menu">
            <!-- Nav items will be rendered here by JS -->
          </div>
        </div>
      </div>
      <div id="linksGrid" class="links-grid">
        <!-- ÈìæÊé•Âç°ÁâáÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÂä†ËΩΩ -->
      </div>
    </main>
  </div>

  <!-- ÈìæÊé•Ê∑ªÂä†/ÁºñËæëÊ®°ÊÄÅÊ°Ü -->
  <div id="linkModalOverlay" class="modal-overlay">
    <div class="modal-box">
      <h3 class="modal-title" id="linkModalTitle">Ê∑ªÂä†ÈìæÊé•</h3>
      <form id="linkForm" class="modal-form">
        <input type="hidden" id="linkId">
        <label for="linkTitle">Ê†áÈ¢ò:</label>
        <input type="text" id="linkTitle" required>

        <label for="linkUrl">URL:</label>
        <input type="url" id="linkUrl" required>

        <label for="linkDescription">ÊèèËø∞:</label>
        <textarea id="linkDescription"></textarea>

        <label for="linkCategory">ÂàÜÁ±ª:</label>
        <select id="linkCategory">
          <!-- ÂàÜÁ±ªÈÄâÈ°πÈÄöËøáJSÂä®ÊÄÅÂ°´ÂÖÖ -->
        </select>

        <div class="checkbox-group">
          <input type="checkbox" id="linkIsPublic">
          <label for="linkIsPublic">ÂÖ¨ÂºÄÂèØËßÅ</label>
        </div>

        <div class="modal-actions">
          <button type="button" class="cancel-btn danger-btn-modal" id="deleteLinkFromModalBtn"
            style="margin-right: auto; display: none;">Âà†Èô§</button>
          <button type="submit" class="save-btn">‰øùÂ≠ò</button>
          <button type="button" class="cancel-btn" id="cancelLinkModalBtn">ÂèñÊ∂à</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ÂàÜÁ±ªÁºñËæëÊ®°ÊÄÅÊ°Ü -->
  <div id="categoryModalOverlay" class="modal-overlay">
    <div class="modal-box">
      <h3 class="modal-title" id="categoryModalTitle">ÁºñËæëÂàÜÁ±ª</h3>
      <form id="categoryForm" class="modal-form">
        <input type="hidden" id="categoryId">
        <label for="categoryName">ÂêçÁß∞:</label>
        <input type="text" id="categoryName" required>

        <div class="checkbox-group">
          <input type="checkbox" id="categoryIsPublic">
          <label for="categoryIsPublic">ÂÖ¨ÂºÄÂèØËßÅ</label>
        </div>

        <div class="modal-actions">
          <button type="button" class="cancel-btn danger-btn-modal" id="deleteCategoryFromModalBtn"
            style="margin-right: auto; display: none;">Âà†Èô§</button>
          <button type="submit" class="save-btn">‰øùÂ≠ò</button>
          <button type="button" class="cancel-btn" id="cancelCategoryModalBtn">ÂèñÊ∂à</button>
        </div>
      </form>
    </div>
  </div>


  <script>
    const API_BASE = '/@links/api/';
    let categories = [];
    let links = [];
    let currentCategoryID = 0; // 0 for "All Links"
    let publicMode = false; // Whether currently viewing public links
    let editMode = false; // New: Global edit mode state

    // --- Â∑•ÂÖ∑ÂáΩÊï∞ ---
    async function fetchData(url, options = {}) {
      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! Status: ${response.status}, Message: ${errorText}`);
        }
        return await response.json();
      } catch (error) {
        console.error("Fetch error:", error);
        alert("ËØ∑Ê±ÇÂ§±Ë¥•: " + error.message);
        throw error;
      }
    }

    function debounce(func, delay) {
      let timeout;
      return function (...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
      };
    }

    // --- ÂàÜÁ±ªÁÆ°ÁêÜ ---
    async function loadCategories(isPublic = false) {
      const url = `${API_BASE}categories${isPublic ? '?public=1' : ''}`;
      categories = await fetchData(url);
      renderCategories();
    }

    function renderCategories() {
      const categoryList = document.getElementById('categoryList');
      categoryList.innerHTML = ''; // Ê∏ÖÁ©∫Áé∞ÊúâÂàÜÁ±ª

      // Ê∑ªÂä†‚ÄúÊâÄÊúâÈìæÊé•‚ÄùÈÄâÈ°π
      const allLinksItem = document.createElement('li');
      const allLinksBtn = document.createElement('button');
      allLinksBtn.textContent = 'ÊâÄÊúâÈìæÊé•';
      allLinksBtn.dataset.id = 0;
      allLinksBtn.classList.add('category-btn');
      if (currentCategoryID === 0 && !publicMode) {
        allLinksBtn.classList.add('active');
      }
      allLinksBtn.addEventListener('click', () => {
        if (!editMode) selectCategory(0, false);
        else openCategoryModal({id: 0, name: 'ÊâÄÊúâÈìæÊé•', is_public: false}); // Example, might need adjustment
      });
      allLinksItem.appendChild(allLinksBtn);
      categoryList.appendChild(allLinksItem);

      // Ê∑ªÂä†‚ÄúÂÖ¨ÂÖ±ÈìæÊé•‚ÄùÈÄâÈ°π
      const publicLinksItem = document.createElement('li');
      const publicLinksBtn = document.createElement('button');
      publicLinksBtn.textContent = 'ÂÖ¨ÂºÄÈìæÊé•';
      publicLinksBtn.dataset.id = -1; // Áî®-1Ë°®Á§∫ÂÖ¨ÂÖ±ÈìæÊé•
      publicLinksBtn.classList.add('category-btn');
      if (publicMode) {
        publicLinksBtn.classList.add('active');
      }
      publicLinksBtn.addEventListener('click', () => {
        if (!editMode) selectCategory(-1, true);
        else openCategoryModal({id: -1, name: 'ÂÖ¨ÂºÄÈìæÊé•', is_public: true}); // Example, might need adjustment
      });
      publicLinksItem.appendChild(publicLinksBtn);
      categoryList.appendChild(publicLinksItem);


      // Ê∏≤ÊüìÂÖ∂‰ªñÂàÜÁ±ª
      categories.forEach(category => {
        const li = document.createElement('li');
        li.dataset.id = category.id;
        li.dataset.sortNum = category.sort_num;
        li.classList.add('category-item'); // Add a class for styling

        const button = document.createElement('button');
        button.textContent = category.name + (category.is_public ? ' (ÂÖ¨ÂºÄ)' : '');
        button.dataset.id = category.id;
        button.classList.add('category-btn');
        if (currentCategoryID === category.id && !publicMode) {
          button.classList.add('active');
        }
        button.addEventListener('click', (e) => {
          if (!editMode) {
            selectCategory(category.id, false);
          } else {
            e.stopPropagation(); // Prevent default if it's a link
            openCategoryModal(category);
          }
        });

        const actionsDiv = document.createElement('div');
        actionsDiv.classList.add('category-actions');

        const editBtn = document.createElement('button');
        editBtn.textContent = 'ÁºñËæë';
        editBtn.classList.add('edit-btn');
        editBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // ÈòªÊ≠¢ÁÇπÂáªÂàÜÁ±ªÊåâÈíÆ
          openCategoryModal(category);
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Âà†Èô§';
        deleteBtn.classList.add('delete-btn');
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteCategory(category.id);
        });

        const dragHandle = document.createElement('span');
        dragHandle.classList.add('category-action-icon');
        dragHandle.textContent = '‚ú†'; // Hamburger icon for drag
        dragHandle.setAttribute('draggable', editMode); // Only draggable in edit mode

        // Attach drag events to the handle
        if (editMode) {
          li.setAttribute('draggable', false); // The li itself is not draggable
          dragHandle.addEventListener('dragstart', (e) => {
            draggedCategory = li; // Drag the whole li
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', li.dataset.id);
            setTimeout(() => li.classList.add('dragging'), 0);
          });
          dragHandle.addEventListener('dragend', () => {
            if (draggedCategory) {
              draggedCategory.classList.remove('dragging');
            }
            document.querySelectorAll('.category-list li').forEach(el => el.classList.remove('drag-over'));
            draggedCategory = null;
          });
        } else {
          li.setAttribute('draggable', false); // Not draggable
        }


        li.appendChild(button);
        // li.appendChild(actionsDiv); // Actions moved to modal
        li.appendChild(dragHandle); // Always append, visibility handled by CSS

        categoryList.appendChild(li);
      });
      // Setup drag and drop for containers (li elements)
      setupCategoryDragAndDrop();
      document.querySelector('.sidebar').classList.toggle('edit-mode', editMode); // Apply edit mode class
    }

    function selectCategory(id, isPublic = false) {
      if (editMode) return; // Prevent navigation in edit mode

      currentCategoryID = id;
      publicMode = isPublic;
      const categoryTitleElement = document.getElementById('currentCategoryTitle');
      if (isPublic) {
        categoryTitleElement.textContent = 'ÂÖ¨ÂºÄÈìæÊé•';
      } else if (id === 0) {
        categoryTitleElement.textContent = 'ÊâÄÊúâÈìæÊé•';
      } else {
        const selectedCategory = categories.find(cat => cat.id === id);
        categoryTitleElement.textContent = selectedCategory ? selectedCategory.name : 'ÊâÄÊúâÈìæÊé•';
      }
      // Êõ¥Êñ∞ÂàÜÁ±ªÂàóË°®ÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
      document.querySelectorAll('.category-btn').forEach(btn => {
        if (parseInt(btn.dataset.id) === id && !isPublic) {
          btn.classList.add('active');
        } else if (parseInt(btn.dataset.id) === -1 && isPublic) {
          btn.classList.add('active');
        }
        else {
          btn.classList.remove('active');
        }
      });
      loadLinks(id, isPublic);
      renderCategories(); // Re-render to update UI for edit mode
    }



    async function deleteCategory(id) {
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§ÂàÜÁ±ªÂêóÔºüÂÖ≥ËÅîÁöÑÈìæÊé•‰∏ç‰ºöË¢´Âà†Èô§Ôºå‰ΩÜ‰ºöÂ§±ÂéªÂàÜÁ±ª„ÄÇ')) return;
      try {
        await fetchData(`${API_BASE}categories?id=${id}`, {method: 'DELETE'});
        await loadCategories();
        // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÂàÜÁ±ªÔºåÂàôÂàáÊç¢Âà∞‚ÄúÊâÄÊúâÈìæÊé•‚Äù
        if (currentCategoryID === id) {
          selectCategory(0, false);
        }
      } catch (error) {
        console.error('Âà†Èô§ÂàÜÁ±ªÂ§±Ë¥•:', error);
      }
    }

    // ÂàÜÁ±ªÁºñËæëÊ®°ÊÄÅÊ°Ü
    const categoryModalOverlay = document.getElementById('categoryModalOverlay');
    const categoryForm = document.getElementById('categoryForm');
    const categoryIdInput = document.getElementById('categoryId');
    const categoryNameInput = document.getElementById('categoryName');
    const categoryIsPublicInput = document.getElementById('categoryIsPublic');
    const categoryModalTitle = document.getElementById('categoryModalTitle');
    const cancelCategoryModalBtn = document.getElementById('cancelCategoryModalBtn');
    const deleteCategoryFromModalBtn = document.getElementById('deleteCategoryFromModalBtn'); // New: Get delete button

    function openCategoryModal(category = null) {
      if (category) {
        categoryIdInput.value = category.id;
        categoryNameInput.value = category.name;
        categoryIsPublicInput.checked = category.is_public;
        categoryModalTitle.textContent = 'ÁºñËæëÂàÜÁ±ª';
        // Only show delete button for existing categories (id != 0 or -1 for "All/Public Links")
        if (category.id !== 0 && category.id !== -1) {
          deleteCategoryFromModalBtn.style.display = 'inline-block';
          deleteCategoryFromModalBtn.onclick = (e) => {
            e.preventDefault(); // Prevent form submission
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§ÂàÜÁ±ªÂêóÔºüÂÖ≥ËÅîÁöÑÈìæÊé•‰∏ç‰ºöË¢´Âà†Èô§Ôºå‰ΩÜ‰ºöÂ§±ÂéªÂàÜÁ±ª„ÄÇ')) {
              deleteCategory(category.id);
              closeCategoryModal();
            }
          };
        } else {
          deleteCategoryFromModalBtn.style.display = 'none';
          deleteCategoryFromModalBtn.onclick = null;
        }
      } else {
        // Mode for adding a new category
        categoryIdInput.value = ''; // Ensure ID is empty for new
        categoryNameInput.value = '';
        categoryIsPublicInput.checked = false; // Default to not public
        categoryModalTitle.textContent = 'Ê∑ªÂä†ÂàÜÁ±ª';
        deleteCategoryFromModalBtn.style.display = 'none'; // Always hide delete for new
        deleteCategoryFromModalBtn.onclick = null;
      }
      categoryModalOverlay.classList.add('open');
    }

    function closeCategoryModal() {
      categoryModalOverlay.classList.remove('open');
      categoryForm.reset();
    }

    categoryForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = parseInt(categoryIdInput.value);
      const name = categoryNameInput.value.trim();
      const is_public = categoryIsPublicInput.checked;

      if (!name) {
        alert('ÂàÜÁ±ªÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫');
        return;
      }

      try {
        await fetchData(`${API_BASE}categories`, {
          method: 'POST', // ÂêéÁ´ØPOSTÁî®‰∫éÊñ∞Â¢ûÊàñÊõ¥Êñ∞ÔºåÊ†πÊçÆIDÂà§Êñ≠
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({id: id, name: name, is_public: is_public})
        });
        closeCategoryModal();
        await loadCategories(); // ÈáçÊñ∞Âä†ËΩΩÂπ∂Ê∏≤ÊüìÂàÜÁ±ª
        loadLinks(currentCategoryID, publicMode); // ÈáçÊñ∞Âä†ËΩΩÈìæÊé•
      } catch (error) {
        console.error('‰øùÂ≠òÂàÜÁ±ªÂ§±Ë¥•:', error);
      }
    });

    cancelCategoryModalBtn.addEventListener('click', closeCategoryModal);
    categoryModalOverlay.addEventListener('click', (e) => {
      if (e.target === categoryModalOverlay) {
        closeCategoryModal();
      }
    });

    // ÂàÜÁ±ªÊãñÊãΩÊéíÂ∫è
    let draggedCategory = null;

    function setupCategoryDragAndDrop() {
      // Clear previous drag event listeners to prevent duplicates
      document.querySelectorAll('#categoryList > li').forEach(item => {
        item.removeEventListener('dragenter', handleDragEnter);
        item.removeEventListener('dragover', handleDragOver);
        item.removeEventListener('dragleave', handleDragLeave);
        item.removeEventListener('drop', handleDropCategory);
      });

      if (!editMode) return; // Only enable drag and drop in edit mode

      const categoryItems = document.querySelectorAll('#categoryList > li'); // All li elements
      categoryItems.forEach(item => {
        // These events should be on the draggable item (li) itself, not the handle
        item.addEventListener('dragenter', handleDragEnter);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('dragleave', handleDragLeave);
        item.addEventListener('drop', handleDropCategory);
      });
    }

    function handleDragEnter(e) {
      e.preventDefault();
      if (this !== draggedCategory) {
        this.classList.add('drag-over');
      }
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }

    function handleDragLeave() {
      this.classList.remove('drag-over');
    }

    function handleDropCategory(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
      if (draggedCategory && draggedCategory !== this) {
        const categoryList = document.getElementById('categoryList');
        const draggedIndex = Array.from(categoryList.children).indexOf(draggedCategory);
        const targetIndex = Array.from(categoryList.children).indexOf(this);

        if (draggedIndex < targetIndex) {
          categoryList.insertBefore(draggedCategory, this.nextSibling);
        } else {
          categoryList.insertBefore(draggedCategory, this);
        }
        updateCategorySortOrder();
      }
    }

    async function updateCategorySortOrder() {
      const sortedItems = Array.from(document.querySelectorAll('#categoryList > li.category-item')); // Select only draggable category items
      const sortData = sortedItems.map((item, index) => ({
        id: parseInt(item.dataset.id),
        sort_num: sortedItems.length - index // ÁÆÄÂçïÂÄíÂ∫èÔºåÁ°Æ‰øùË∂äÈù†ÂâçÁöÑsort_numË∂äÂ§ß
      }));

      try {
        await fetchData(`${API_BASE}categories/sort`, {
          method: 'PATCH',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(sortData)
        });
        console.log('ÂàÜÁ±ªÊéíÂ∫èÊõ¥Êñ∞ÊàêÂäü');
        await loadCategories(); // ÈáçÊñ∞Âä†ËΩΩÊúÄÊñ∞ÁöÑÂàÜÁ±ªÊï∞ÊçÆ
        renderCategories(); // ÈáçÊñ∞Ê∏≤ÊüìÂàÜÁ±ªÂàóË°®
      } catch (error) {
        console.error('Êõ¥Êñ∞ÂàÜÁ±ªÊéíÂ∫èÂ§±Ë¥•:', error);
      }
    }


    // --- ÈìæÊé•ÁÆ°ÁêÜ ---
    async function loadLinks(categoryID = 0, isPublic = false) {
      let url = `${API_BASE}links`;
      const params = [];
      if (categoryID > 0) {
        params.push(`category_id=${categoryID}`);
      }
      if (isPublic) {
        params.push('public=1');
      }
      if (params.length > 0) {
        url += `?${params.join('&')}`;
      }

      try {
        links = await fetchData(url);
      } catch (error) {
        console.error("[links] Âä†ËΩΩÈìæÊé•Â§±Ë¥•:", error);
        links = []; // Á°Æ‰øù links ÊòØ‰∏Ä‰∏™Êï∞ÁªÑÔºåÂç≥‰ΩøÂú®ÈîôËØØÂèëÁîüÊó∂
      }
      filterAndRenderLinks(); // Initial render and filter
    }

    function renderLinks(filteredLinks) {
      const linksGrid = document.getElementById('linksGrid');
      linksGrid.innerHTML = '';
      if (filteredLinks.length === 0) {
        linksGrid.innerHTML = '<p style="text-align: center; color: var(--text-secondary); width: 100%;">ËØ•ÂàÜÁ±ª‰∏ãÊ≤°ÊúâÈìæÊé•„ÄÇ</p>';
        return;
      }

      filteredLinks.forEach(link => {
        const card = document.createElement('div');
        card.classList.add('link-card');
        card.dataset.id = link.id;
        card.dataset.sortNum = link.sort_num;

        const linkTitleElement = document.createElement('h4');
        linkTitleElement.textContent = link.title;

        // The entire link card (anchor) will be clickable for navigation
        const linkAnchor = document.createElement('a');
        linkAnchor.href = link.url;
        linkAnchor.target = '_blank';
        linkAnchor.classList.add('link-url');
        linkAnchor.appendChild(linkTitleElement); // Title is inside the anchor

        const descriptionTooltip = document.createElement('div');
        descriptionTooltip.classList.add('description-tooltip');
        descriptionTooltip.textContent = link.description || 'Êó†ÊèèËø∞';
        card.appendChild(descriptionTooltip); // Â∞ÜÊµÆÂ±ÇÊ∑ªÂä†Âà∞Âç°ÁâáÂÜÖÈÉ®Ôºå‰æø‰∫éÁõ∏ÂØπÂÆö‰Ωç

        const actionIcon = document.createElement('span');
        actionIcon.classList.add('action-icon');
        if (!editMode) {
          actionIcon.textContent = '‚Ä¢'; // ÂõæÊ†á
        } else {
          actionIcon.textContent = '‚ú†'; // ÁºñËæëÊ®°Âºè
        }

        // Append elements to card
        card.appendChild(linkAnchor);
        card.appendChild(actionIcon); // Action icon next to title
        linksGrid.appendChild(card);

        // --- ‰∫ã‰ª∂ÁªëÂÆö ---
        if (!editMode) {
          // ÈùûÁºñËæëÊ®°ÂºèÔºöÁÇπÂáªÊàñÊÇ¨ÂÅúÊòæÁ§∫ÊèèËø∞ÊµÆÂ±Ç
          let hideTooltipTimer = null;
          function showTooltip() {
            // ÂÆö‰ΩçÊµÆÂ±ÇÂà∞icon‰∏ãÊñπ
            // ÊµÆÂ±ÇÁé∞Âú®ÈÄöËøáCSSÂÆö‰ΩçÔºåÊó†ÈúÄJSÂä®ÊÄÅËÆ°ÁÆó
            descriptionTooltip.classList.add('show');
          }
          function hideTooltip() {
            descriptionTooltip.classList.remove('show');
          }
          actionIcon.addEventListener('mouseenter', showTooltip);
          actionIcon.addEventListener('mouseleave', () => {
            hideTooltipTimer = setTimeout(hideTooltip, 150);
          });
          actionIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            showTooltip();
          });
          descriptionTooltip.addEventListener('mouseenter', () => {
            if (hideTooltipTimer) clearTimeout(hideTooltipTimer);
            descriptionTooltip.classList.add('show');
          });
          descriptionTooltip.addEventListener('mouseleave', hideTooltip);
          // ÁÇπÂáªÈ°µÈù¢ÂÖ∂‰ªñÂú∞ÊñπÈöêËóèÊµÆÂ±Ç
          document.addEventListener('click', (e) => {
            if (!actionIcon.contains(e.target) && !descriptionTooltip.contains(e.target)) {
              hideTooltip();
            }
          });
        } else {
          // ÁºñËæëÊ®°ÂºèÔºöaction-icon Âèò‰∏∫‰∏âÊ®™Á∫øÔºå‰ªÖÁî®‰∫éÊãñÂä®
          card.classList.add('edit-mode');
          card.setAttribute('draggable', false);
          actionIcon.setAttribute('draggable', true);
          actionIcon.addEventListener('dragstart', (e) => {
            draggedLink = card;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', card.dataset.id);
            setTimeout(() => card.classList.add('dragging'), 0);
          });
          actionIcon.addEventListener('dragend', () => {
            if (draggedLink) {
              draggedLink.classList.remove('dragging');
            }
            document.querySelectorAll('.link-card').forEach(el => el.classList.remove('drag-over'));
            draggedLink = null;
          });
        }
      });

      // Setup drag and drop for links grid containers
      setupLinkDragAndDrop();
    }

    function filterAndRenderLinks() {
      const searchInput = document.getElementById('linkSearchInput');
      const searchTerm = searchInput.value.toLowerCase();
      const filteredLinks = (links && Array.isArray(links)) ? links.filter(link =>
        link.title.toLowerCase().includes(searchTerm) ||
        link.description.toLowerCase().includes(searchTerm)
      ) : []; // Â¶ÇÊûú links Êó†ÊïàÔºåÂàôËøîÂõûÁ©∫Êï∞ÁªÑ
      renderLinks(filteredLinks);
    }

    // ÈìæÊé•Ê∑ªÂä†/ÁºñËæëÊ®°ÊÄÅÊ°Ü
    const linkModalOverlay = document.getElementById('linkModalOverlay');
    const linkForm = document.getElementById('linkForm');
    const linkIdInput = document.getElementById('linkId');
    const linkTitleInput = document.getElementById('linkTitle');
    const linkUrlInput = document.getElementById('linkUrl');
    const linkDescriptionInput = document.getElementById('linkDescription');
    const linkCategorySelect = document.getElementById('linkCategory');
    const linkIsPublicInput = document.getElementById('linkIsPublic');
    const linkModalTitle = document.getElementById('linkModalTitle');
    const cancelLinkModalBtn = document.getElementById('cancelLinkModalBtn');
    const deleteLinkFromModalBtn = document.getElementById('deleteLinkFromModalBtn'); // New: Get delete button

    function openLinkModal(link = null) {
      // Â°´ÂÖÖÂàÜÁ±ªÈÄâÈ°π
      linkCategorySelect.innerHTML = '<option value="0">Êó†ÂàÜÁ±ª</option>';
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        linkCategorySelect.appendChild(option);
      });

      if (link) {
        linkIdInput.value = link.id;
        linkTitleInput.value = link.title;
        linkUrlInput.value = link.url;
        linkDescriptionInput.value = link.description;
        linkCategorySelect.value = link.category_id || 0;
        linkIsPublicInput.checked = link.is_public;
        linkModalTitle.textContent = 'ÁºñËæëÈìæÊé•';
        deleteLinkFromModalBtn.style.display = 'inline-block'; // Show delete button for existing link
        deleteLinkFromModalBtn.onclick = (e) => {
          e.preventDefault(); // Prevent form submission
          if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§ÈìæÊé•ÂêóÔºü')) {
            deleteLink(link.id);
            closeLinkModal();
          }
        };
      } else {
        linkIdInput.value = '';
        linkForm.reset();
        linkCategorySelect.value = currentCategoryID > 0 ? currentCategoryID : 0; // Default select current category
        linkModalTitle.textContent = 'Ê∑ªÂä†ÈìæÊé•';
        deleteLinkFromModalBtn.style.display = 'none'; // Hide delete button for new link
        deleteLinkFromModalBtn.onclick = null; // Clear handler
      }
      linkModalOverlay.classList.add('open');
    }

    function closeLinkModal() {
      linkModalOverlay.classList.remove('open');
      linkForm.reset();
    }

    linkForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = linkIdInput.value ? parseInt(linkIdInput.value) : 0;
      const title = linkTitleInput.value.trim();
      const url = linkUrlInput.value.trim();
      const description = linkDescriptionInput.value.trim();
      const category_id = parseInt(linkCategorySelect.value) || 0;
      const is_public = linkIsPublicInput.checked;

      if (!title || !url) {
        alert('Ê†áÈ¢òÂíåURL‰∏çËÉΩ‰∏∫Á©∫');
        return;
      }

      const linkData = {
        id: id,
        title: title,
        url: url,
        description: description,
        category_id: category_id,
        is_public: is_public,
        sort_num: 0 // Êñ∞Â¢ûÊó∂ÈªòËÆ§ÊéíÂ∫è
      };

      try {
        await fetchData(`${API_BASE}link`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(linkData)
        });
        closeLinkModal();
        await loadLinks(currentCategoryID, publicMode); // ÈáçÊñ∞Âä†ËΩΩÂπ∂Ê∏≤ÊüìÈìæÊé•
      } catch (error) {
        console.error('‰øùÂ≠òÈìæÊé•Â§±Ë¥•:', error);
      }
    });

    cancelLinkModalBtn.addEventListener('click', closeLinkModal);
    linkModalOverlay.addEventListener('click', (e) => {
      if (e.target === linkModalOverlay) {
        closeLinkModal();
      }
    });

    async function deleteLink(id) {
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§ÈìæÊé•ÂêóÔºü')) return;
      try {
        await fetchData(`${API_BASE}link?id=${id}`, {method: 'DELETE'});
        await loadLinks(currentCategoryID, publicMode); // ÈáçÊñ∞Âä†ËΩΩÂπ∂Ê∏≤ÊüìÈìæÊé•
      } catch (error) {
        console.error('Âà†Èô§ÈìæÊé•Â§±Ë¥•:', error);
      }
    }

    // ÈìæÊé•ÊãñÊãΩÊéíÂ∫è
    let draggedLink = null;
    const linksGrid = document.getElementById('linksGrid');

    function setupLinkDragAndDrop() {
      // Clear previous drag event listeners to prevent duplicates
      document.querySelectorAll('.link-card').forEach(card => {
        card.removeEventListener('dragenter', handleLinkDragEnter);
        card.removeEventListener('dragover', handleLinkDragOver);
        card.removeEventListener('dragleave', handleLinkDragLeave);
        card.removeEventListener('drop', handleDropLink);
      });

      if (!editMode) return; // Only enable drag and drop in edit mode

      const linkCards = document.querySelectorAll('.link-card');
      linkCards.forEach(card => {
        // These events should be on the draggable item (card) itself, not the handle
        card.addEventListener('dragenter', handleLinkDragEnter);
        card.addEventListener('dragover', handleLinkDragOver);
        card.addEventListener('dragleave', handleLinkDragLeave);
        card.addEventListener('drop', handleDropLink);
      });
    }

    function handleLinkDragEnter(e) {
      e.preventDefault();
      if (this !== draggedLink) {
        this.classList.add('drag-over');
      }
    }

    function handleLinkDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }

    function handleLinkDragLeave() {
      this.classList.remove('drag-over');
    }

    function handleDropLink(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
      if (draggedLink && draggedLink !== this) {
        const linksGrid = document.getElementById('linksGrid');
        const draggedIndex = Array.from(linksGrid.children).indexOf(draggedLink);
        const targetIndex = Array.from(linksGrid.children).indexOf(this);

        if (draggedIndex < targetIndex) {
          linksGrid.insertBefore(draggedLink, this.nextSibling);
        } else {
          linksGrid.insertBefore(draggedLink, this);
        }
        updateLinkSortOrder();
      }
    }

    async function updateLinkSortOrder() {
      const sortedItems = Array.from(document.querySelectorAll('.link-card'));
      const sortData = sortedItems.map((item, index) => ({
        id: parseInt(item.dataset.id),
        sort_num: sortedItems.length - index // ÁÆÄÂçïÂÄíÂ∫èÔºåÁ°Æ‰øùË∂äÈù†ÂâçÁöÑsort_numË∂äÂ§ß
      }));

      try {
        await fetchData(`${API_BASE}links/sort`, {
          method: 'PATCH',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(sortData)
        });
        console.log('ÈìæÊé•ÊéíÂ∫èÊõ¥Êñ∞ÊàêÂäü');
        await loadLinks(); // ÈáçÊñ∞Âä†ËΩΩÊúÄÊñ∞ÁöÑÈìæÊé•Êï∞ÊçÆ
        filterAndRenderLinks(); // ÈáçÊñ∞Ê∏≤ÊüìÈìæÊé•ÂàóË°®
      } catch (error) {
        console.error('Êõ¥Êñ∞ÈìæÊé•ÊéíÂ∫èÂ§±Ë¥•:', error);
      }
    }


    // --- ÂàùÂßãÂåñÂíå‰∫ã‰ª∂ÁªëÂÆö ---
    document.addEventListener('DOMContentLoaded', async () => {
      // Ëé∑ÂèñÂ∏∏Áî®DOMÂÖÉÁ¥†
      const toggleEditModeBtn = document.getElementById('toggleEditModeBtn');
      const addLinkBtn = document.getElementById('addLinkBtn');
      const addCategoryBtn = document.getElementById('addCategoryBtn');
      const linkSearchInput = document.getElementById('linkSearchInput');
      const newCategoryNameInput = document.getElementById('newCategoryName');

      // ÂÆö‰πâÂàáÊç¢ÁºñËæëÊ®°ÂºèÂáΩÊï∞
      function toggleEditMode() {
        editMode = !editMode;
        toggleEditModeBtn.textContent = editMode ? 'ÈÄÄÂá∫ÁºñËæëÊ®°Âºè' : 'ËøõÂÖ•ÁºñËæëÊ®°Âºè';

        // ÂàáÊç¢ÊåâÈíÆÂíåËæìÂÖ•Ê°ÜÁöÑÊòæÁ§∫
        addLinkBtn.style.display = editMode ? 'inline-block' : 'none'; // Only visible in edit mode
        addCategoryBtn.style.display = editMode ? 'inline-block' : 'none'; // Only visible in edit mode
        linkSearchInput.style.display = editMode ? 'none' : 'inline-block'; // Hidden in edit mode
        // newCategoryNameInput is removed from HTML, so this line is no longer needed

        // ÈáçÊñ∞Ê∏≤ÊüìUI
        renderCategories();      // ÈáçÊñ∞Ê∏≤ÊüìÂàÜÁ±ª‰ª•Â∫îÁî®ÁºñËæëÊ®°ÂºèÊ†∑ÂºèÂíå‰∫ã‰ª∂
        filterAndRenderLinks();  // ÈáçÊñ∞Ê∏≤ÊüìÈìæÊé•‰ª•Â∫îÁî®ÁºñËæëÊ®°ÂºèÊ†∑ÂºèÂíå‰∫ã‰ª∂
      }

      // ÂàùÂßãÂåñÂä†ËΩΩÊï∞ÊçÆ
      await loadCategories();
      await loadLinks(currentCategoryID, publicMode);
      renderNavigationMenu(); // Ê∏≤ÊüìÂØºËà™ËèúÂçï

      // ÈìæÊé•ÊêúÁ¥¢ËæìÂÖ•Ê°Ü‰∫ã‰ª∂
      linkSearchInput.addEventListener('input', debounce(filterAndRenderLinks, 300));

      // Ê∑ªÂä†ÈìæÊé•ÊåâÈíÆ
      addLinkBtn.addEventListener('click', () => openLinkModal());
      // Ê∑ªÂä†ÂàÜÁ±ªÊåâÈíÆ
      addCategoryBtn.addEventListener('click', () => openCategoryModal());

      // ÂàùÂßãÈÄâÊã©‚ÄúÊâÄÊúâÈìæÊé•‚Äù
      selectCategory(0, false);
      // ÁªëÂÆö‰∏ªÈ¢òËÆæÁΩÆÊåâÈíÆ
      if (window.bindThemeButton) {
        window.bindThemeButton();
      }

      // ‰ªÖÂú®ÁôªÂΩïÊó∂ÊòæÁ§∫ÁºñËæëÊ®°ÂºèÊåâÈíÆÂπ∂ÁªëÂÆö‰∫ã‰ª∂
      if (window.isLoggedIn && window.isLoggedIn()) {
        toggleEditModeBtn.style.display = 'inline-block';
        toggleEditModeBtn.addEventListener('click', toggleEditMode);
      }
    });

    // --- ÂØºËà™ËèúÂçïÊ∏≤Êüì ---
    function renderNavigationMenu() {
      const hamburgerIcon = document.getElementById('hamburgerIcon');
      const dropdownNavMenu = document.getElementById('dropdownNavMenu');
      dropdownNavMenu.innerHTML = ''; // Ê∏ÖÁ©∫Áé∞ÊúâÂÜÖÂÆπ

      if (window.GlobalNavMenu) {
        const isLoggedIn = window.isLoggedIn ? window.isLoggedIn() : false;

        window.GlobalNavMenu.forEach(item => {
          // Ê†πÊçÆÁôªÂΩïÁä∂ÊÄÅËøáÊª§ÂØºËà™È°π
          if (item.onlyWhenNotLogin && isLoggedIn) {
            return;
          }
          if (item.onlyWhenLogin && !isLoggedIn) {
            return;
          }

          const link = document.createElement('a');
          link.href = item.url;
          link.textContent = item.name;
          link.classList.add('nav-item'); // ‰ΩøÁî®Êñ∞ÁöÑclass for dropdown items

          // Â¶ÇÊûúÊòØÈÄÄÂá∫ÊåâÈíÆÔºå‰ΩøÁî®ÂÆö‰πâÁöÑÂáΩÊï∞
          if (item.key === 'logout') {
            link.href = 'javascript:void(0)'; // Èò≤Ê≠¢È°µÈù¢Ë∑≥ËΩ¨
            link.addEventListener('click', (e) => {
              e.preventDefault(); // Prevent default link behavior
              if (window.logoutAndRedirect) {
                window.logoutAndRedirect();
                // Close menu after action
                dropdownNavMenu.classList.remove('open');
              }
            });
          } else {
            // For other links, close menu on click
            link.addEventListener('click', () => {
              dropdownNavMenu.classList.remove('open');
            });
          }

          dropdownNavMenu.appendChild(link);
        });
      }

      // Ê±âÂ†°ÂõæÊ†áÁÇπÂáª‰∫ã‰ª∂
      hamburgerIcon.addEventListener('click', (e) => {
        e.stopPropagation(); // Èò≤Ê≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞documentÔºåÁ´ãÂç≥ÂÖ≥Èó≠
        dropdownNavMenu.classList.toggle('open');
      });

      // ÁÇπÂáªÊñáÊ°£ÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
      document.addEventListener('click', (e) => {
        if (!hamburgerIcon.contains(e.target) && !dropdownNavMenu.contains(e.target)) {
          dropdownNavMenu.classList.remove('open');
        }
      });
    }
  </script>
</body>

</html>
