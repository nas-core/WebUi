<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„é“¾æ¥</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”—</text></svg>">
  <style>
    :root {
      --bg-body: #f8f9fa;
      --bg-card: #ffffff;
      --text-main: #212529;
      --text-secondary: #6c757d;
      --border-color: #dee2e6;
      --primary-color: #007bff;
      --primary-hover-color: #0056b3;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --input-bg: #fff;
      --input-border: #ced4da;
      --shadow-light: rgba(0, 0, 0, 0.05);
      --shadow-medium: rgba(0, 0, 0, 0.1);
      --highlight-bg: #e2f0ff;
      --category-active-bg: #e9ecef;
      --category-active-border: #007bff;
    }

    [data-theme='dark'] {
      --bg-body: #1a1a1a;
      --bg-card: #2c2c2c;
      --text-main: #e0e0e0;
      --text-secondary: #b0b0b0;
      --border-color: #444444;
      --primary-color: #6a9cff;
      --primary-hover-color: #4a7cdd;
      --success-color: #4caf50;
      --danger-color: #ff6b6b;
      --input-bg: #3a3a3a;
      --input-border: #555555;
      --shadow-light: rgba(0, 0, 0, 0.2);
      --shadow-medium: rgba(0, 0, 0, 0.3);
      --highlight-bg: #2b3d57;
      --category-active-bg: #3d3d3d;
      --category-active-border: #6a9cff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      line-height: 1.6;
      color: var(--text-main);
      background-color: var(--bg-body);
      transition: background-color 0.3s, color 0.3s;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .container {
      max-width: 96rem;
      width: 100%;
      margin: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 1.25rem;
      flex-grow: 1;
    }

    /* ä¾§è¾¹æ æ ·å¼ */
    .sidebar {
      flex: 0 0 16rem;
      /* å›ºå®šå®½åº¦ */
      background-color: var(--bg-card);
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.125rem 0.25rem var(--shadow-light);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      height: fit-content;
      /* è®©ä¾§è¾¹æ é«˜åº¦é€‚åº”å†…å®¹ */
      position: sticky;
      /* ç²˜æ€§å®šä½ */
      top: 1.25rem;
      /* è·ç¦»é¡¶éƒ¨1.25rem */
    }

    .sidebar h3 {
      font-size: 1.125rem;
      margin-bottom: 0.5rem;
      color: var(--text-main);
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar li {
      margin-bottom: 0.5rem;
    }

    .sidebar a,
    .sidebar button {
      display: block;
      width: 100%;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      color: var(--text-main);
      text-decoration: none;
      background-color: transparent;
      border: 1px solid transparent;
      text-align: left;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
      font-size: 0.9375rem;
    }

    .sidebar a:hover,
    .sidebar button:hover {
      background-color: var(--bg-body);
    }

    .sidebar a.active,
    .sidebar button.active {
      background-color: var(--category-active-bg);
      border-color: var(--category-active-border);
      color: var(--primary-color);
      font-weight: bold;
    }

    .sidebar .search-input,
    .sidebar .add-category-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--input-border);
      border-radius: 0.375rem;
      background-color: var(--input-bg);
      color: var(--text-main);
      font-size: 0.9375rem;
      margin-bottom: 0.5rem;
    }

    .sidebar .add-category-btn {
      background-color: var(--success-color);
      color: #fff;
      border: none;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      cursor: pointer;
      width: 100%;
      font-size: 0.9375rem;
      transition: background-color 0.2s;
    }

    .sidebar .add-category-btn:hover {
      background-color: #218838;
    }

    .sidebar .category-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }

    .sidebar .category-actions button {
      flex-grow: 1;
      font-size: 0.875rem;
      padding: 0.3rem 0.5rem;
      border: none;
      border-radius: 0.25rem;
      cursor: pointer;
      color: #fff;
    }

    .sidebar .category-actions .edit-btn {
      background-color: var(--primary-color);
    }

    .sidebar .category-actions .edit-btn:hover {
      background-color: var(--primary-hover-color);
    }

    .sidebar .category-actions .delete-btn {
      background-color: var(--danger-color);
    }

    .sidebar .category-actions .delete-btn:hover {
      background-color: #c82333;
    }

    .sidebar .category-actions .save-btn {
      background-color: var(--success-color);
    }

    .sidebar .category-actions .save-btn:hover {
      background-color: #218838;
    }

    .sidebar .category-actions .cancel-btn {
      background-color: var(--text-secondary);
    }

    .sidebar .category-actions .cancel-btn:hover {
      background-color: #5a6268;
    }

    /* ä¸»å†…å®¹åŒºåŸŸæ ·å¼ */
    .main-content {
      flex: 1;
      min-width: 0;
      /* Allow content to shrink */
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .header-actions {
      background-color: var(--bg-card);
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.125rem 0.25rem var(--shadow-light);
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .header-actions .search-input {
      flex: 1;
      min-width: 10rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--input-border);
      border-radius: 0.375rem;
      background-color: var(--input-bg);
      color: var(--text-main);
      font-size: 0.9375rem;
    }

    .header-actions button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.9375rem;
      transition: background-color 0.2s;
    }

    .header-actions .add-link-btn {
      background-color: var(--primary-color);
      color: #fff;
    }

    .header-actions .add-link-btn:hover {
      background-color: var(--primary-hover-color);
    }

    .header-actions .theme-toggle-btn {
      background-color: var(--text-secondary);
      color: #fff;
    }

    .header-actions .theme-toggle-btn:hover {
      background-color: #5a6268;
    }

    .header-actions .current-category-title {
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--primary-color);
      margin-right: auto;
      /* Push other items to the right */
    }

    /* æ±‰å ¡èœå•æ ·å¼ */
    .hamburger-menu-container {
      position: relative;
      /* ç”¨äºå®šä½ä¸‹æ‹‰èœå• */
      margin-left: 0.75rem;
      /* ä¸å…¶ä»–æŒ‰é’®çš„é—´éš” */
      display: flex;
      align-items: center;
    }

    .hamburger-icon {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      width: 2rem;
      height: 2rem;
      background: var(--primary-color);
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      padding: 0.4rem;
      box-sizing: border-box;
      transition: background-color 0.2s;
    }

    .hamburger-icon:hover {
      background-color: var(--primary-hover-color);
    }

    .hamburger-icon .line {
      width: 100%;
      height: 0.2rem;
      background-color: #fff;
      border-radius: 0.125rem;
      transition: all 0.2s ease-in-out;
    }

    /* ä¸‹æ‹‰èœå•æ ·å¼ */
    .dropdown-menu {
      position: absolute;
      top: 100%;
      /* ä½äºæ±‰å ¡å›¾æ ‡ä¸‹æ–¹ */
      right: 0;
      /* å¯¹é½å³ä¾§ */
      background-color: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      box-shadow: 0 0.25rem 0.5rem var(--shadow-medium);
      min-width: 10rem;
      padding: 0.5rem 0;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-0.625rem);
      transition: opacity 0.2s ease-out, visibility 0.2s ease-out, transform 0.2s ease-out;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .dropdown-menu.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-menu .nav-item {
      display: block;
      padding: 0.5rem 1rem;
      color: var(--text-main);
      text-decoration: none;
      white-space: nowrap;
      transition: background-color 0.2s;
    }

    .dropdown-menu .nav-item:hover {
      background-color: var(--bg-body);
    }

    .links-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(18rem, 1fr));
      gap: 1.25rem;
      flex-grow: 1;
    }

    .link-card {
      background-color: var(--bg-card);
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.125rem 0.25rem var(--shadow-light);
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border-color);
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: grab;
      /* Indicate draggable */
    }

    .link-card:active {
      cursor: grabbing;
    }

    .link-card.dragging {
      opacity: 0.5;
      box-shadow: 0 0.5rem 1rem var(--shadow-medium);
    }

    .link-card.drag-over {
      border: 2px dashed var(--primary-color);
    }

    .link-card h4 {
      font-size: 1.125rem;
      margin-bottom: 0.5rem;
      color: var(--primary-color);
    }

    .link-card p {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
      flex-grow: 1;
      /* Pushes button to bottom */
    }

    .link-card .link-url {
      display: block;
      color: var(--primary-color);
      text-decoration: none;
      word-break: break-all;
      margin-bottom: 0.75rem;
      font-size: 0.9375rem;
    }

    .link-card .link-url:hover {
      text-decoration: underline;
    }

    .link-card .actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .link-card .actions button {
      padding: 0.4rem 0.75rem;
      border: none;
      border-radius: 0.25rem;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background-color 0.2s;
      color: #fff;
    }

    .link-card .actions .edit-btn {
      background-color: var(--primary-color);
    }

    .link-card .actions .edit-btn:hover {
      background-color: var(--primary-hover-color);
    }

    .link-card .actions .delete-btn {
      background-color: var(--danger-color);
    }

    .link-card .actions .delete-btn:hover {
      background-color: #c82333;
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .modal-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .modal-box {
      background-color: var(--bg-card);
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.5rem 1rem var(--shadow-medium);
      width: 90%;
      max-width: 30rem;
      color: var(--text-main);
      transform: translateY(-1.25rem);
      transition: transform 0.3s;
      position: relative;
    }

    .modal-overlay.open .modal-box {
      transform: translateY(0);
    }

    .modal-title {
      font-size: 1.375rem;
      margin-bottom: 1.25rem;
      color: var(--primary-color);
    }

    .modal-form label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
      font-size: 0.9375rem;
    }

    .modal-form input[type="text"],
    .modal-form input[type="url"],
    .modal-form textarea,
    .modal-form select {
      width: 100%;
      padding: 0.625rem;
      margin-bottom: 1rem;
      border: 1px solid var(--input-border);
      border-radius: 0.375rem;
      background-color: var(--input-bg);
      color: var(--text-main);
      font-size: 0.9375rem;
    }

    .modal-form textarea {
      resize: vertical;
      min-height: 5rem;
    }

    .modal-form .checkbox-group {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      font-size: 0.9375rem;
    }

    .modal-form .checkbox-group input[type="checkbox"] {
      margin-right: 0.5rem;
      width: auto;
      margin-bottom: 0;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .modal-actions button {
      padding: 0.625rem 1.25rem;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.9375rem;
      transition: background-color 0.2s;
    }

    .modal-actions .save-btn {
      background-color: var(--primary-color);
      color: #fff;
    }

    .modal-actions .save-btn:hover {
      background-color: var(--primary-hover-color);
    }

    .modal-actions .cancel-btn {
      background-color: var(--border-color);
      color: var(--text-main);
    }

    .modal-actions .cancel-btn:hover {
      background-color: #d1d7dc;
    }

    [data-theme='dark'] .modal-actions .cancel-btn {
      background-color: #555555;
      color: #e0e0e0;
    }

    [data-theme='dark'] .modal-actions .cancel-btn:hover {
      background-color: #666666;
    }

    /* åº•éƒ¨å¯¼èˆªæˆ–ä¿¡æ¯ */
    .footer {
      margin-top: 2rem;
      text-align: center;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      .sidebar {
        flex: none;
        /* Remove fixed width */
        width: 100%;
        /* Take full width */
        position: static;
        /* Remove sticky on mobile */
        margin-bottom: 1.25rem;
      }

      .header-actions {
        /* Adjust header actions to accommodate hamburger menu better on small screens */
        flex-wrap: wrap;
        justify-content: space-between;
      }

      .header-actions .search-input {
        width: 100%;
        margin-bottom: 0.5rem;
      }

      .header-actions .current-category-title {
        margin-right: 0;
        margin-bottom: 0.5rem;
        text-align: center;
        margin-bottom: 1rem;
      }

      .header-actions button {
        width: 100%;
      }

      .hamburger-menu-container {
        order: 3;
        /* Hamburger menu last */
        margin-left: auto;
        /* Push to right */
      }

      .dropdown-menu {
        left: auto;
        right: 0;
        /* Align right on small screens */
      }

      .links-grid {
        grid-template-columns: 1fr;
        /* Single column on mobile */
      }
    }
  </style>
</head>

<body>
  <script src="/@public/theme.js"></script>
  <script src="/@public/nav.js"></script>

  <div class="container">
    <!-- ä¾§è¾¹æ  - åˆ†ç±»åˆ—è¡¨ -->
    <aside class="sidebar">
      <h3>é“¾æ¥åˆ†ç±»</h3>
      <input type="text" id="categorySearchInput" class="search-input" placeholder="æœç´¢åˆ†ç±»...">
      <ul id="categoryList" class="category-list">
        <!-- åˆ†ç±»é¡¹å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
      </ul>
      <div class="add-category-section">
        <input type="text" id="newCategoryName" class="add-category-input" placeholder="æ–°åˆ†ç±»åç§°">
        <button id="addCategoryBtn" class="add-category-btn">æ·»åŠ åˆ†ç±»</button>
      </div>
    </aside>

    <!-- ä¸»å†…å®¹åŒºåŸŸ - é“¾æ¥åˆ—è¡¨ -->
    <main class="main-content">
      <div class="header-actions">
        <h2 id="currentCategoryTitle" class="current-category-title">æ‰€æœ‰é“¾æ¥</h2>
        <input type="text" id="linkSearchInput" class="search-input" placeholder="æœç´¢é“¾æ¥æ ‡é¢˜æˆ–æè¿°...">
        <button id="addLinkBtn" class="add-link-btn">æ·»åŠ é“¾æ¥</button>
        <button class="theme-toggle-btn" data-action="open-theme-modal">ä¸»é¢˜è®¾ç½® <span
            id="currentThemeText"></span></button>
        <div class="hamburger-menu-container">
          <button id="hamburgerIcon" class="hamburger-icon">
            <span class="line"></span>
            <span class="line"></span>
            <span class="line"></span>
          </button>
          <div id="dropdownNavMenu" class="dropdown-menu">
            <!-- Nav items will be rendered here by JS -->
          </div>
        </div>
      </div>
      <div id="linksGrid" class="links-grid">
        <!-- é“¾æ¥å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
      </div>
    </main>
  </div>

  <!-- é“¾æ¥æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
  <div id="linkModalOverlay" class="modal-overlay">
    <div class="modal-box">
      <h3 class="modal-title" id="linkModalTitle">æ·»åŠ é“¾æ¥</h3>
      <form id="linkForm" class="modal-form">
        <input type="hidden" id="linkId">
        <label for="linkTitle">æ ‡é¢˜:</label>
        <input type="text" id="linkTitle" required>

        <label for="linkUrl">URL:</label>
        <input type="url" id="linkUrl" required>

        <label for="linkDescription">æè¿°:</label>
        <textarea id="linkDescription"></textarea>

        <label for="linkCategory">åˆ†ç±»:</label>
        <select id="linkCategory">
          <!-- åˆ†ç±»é€‰é¡¹é€šè¿‡JSåŠ¨æ€å¡«å…… -->
        </select>

        <div class="checkbox-group">
          <input type="checkbox" id="linkIsPublic">
          <label for="linkIsPublic">å…¬å¼€å¯è§</label>
        </div>

        <div class="modal-actions">
          <button type="submit" class="save-btn">ä¿å­˜</button>
          <button type="button" class="cancel-btn" id="cancelLinkModalBtn">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- åˆ†ç±»ç¼–è¾‘æ¨¡æ€æ¡† -->
  <div id="categoryModalOverlay" class="modal-overlay">
    <div class="modal-box">
      <h3 class="modal-title" id="categoryModalTitle">ç¼–è¾‘åˆ†ç±»</h3>
      <form id="categoryForm" class="modal-form">
        <input type="hidden" id="categoryId">
        <label for="categoryName">åç§°:</label>
        <input type="text" id="categoryName" required>

        <div class="checkbox-group">
          <input type="checkbox" id="categoryIsPublic">
          <label for="categoryIsPublic">å…¬å¼€å¯è§</label>
        </div>

        <div class="modal-actions">
          <button type="submit" class="save-btn">ä¿å­˜</button>
          <button type="button" class="cancel-btn" id="cancelCategoryModalBtn">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>


  <script>
    const API_BASE = '/@links/api/';
    let categories = [];
    let links = [];
    let currentCategoryID = 0; // 0 for "All Links"
    let publicMode = false; // Whether currently viewing public links

    // --- å·¥å…·å‡½æ•° ---
    async function fetchData(url, options = {}) {
      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! Status: ${response.status}, Message: ${errorText}`);
        }
        return await response.json();
      } catch (error) {
        console.error("Fetch error:", error);
        alert("è¯·æ±‚å¤±è´¥: " + error.message);
        throw error;
      }
    }

    function debounce(func, delay) {
      let timeout;
      return function (...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
      };
    }

    // --- åˆ†ç±»ç®¡ç† ---
    async function loadCategories(isPublic = false) {
      const url = `${API_BASE}categories${isPublic ? '?public=1' : ''}`;
      categories = await fetchData(url);
      renderCategories();
    }

    function renderCategories() {
      const categoryList = document.getElementById('categoryList');
      categoryList.innerHTML = ''; // æ¸…ç©ºç°æœ‰åˆ†ç±»

      // æ·»åŠ â€œæ‰€æœ‰é“¾æ¥â€é€‰é¡¹
      const allLinksItem = document.createElement('li');
      const allLinksBtn = document.createElement('button');
      allLinksBtn.textContent = 'æ‰€æœ‰é“¾æ¥';
      allLinksBtn.dataset.id = 0;
      allLinksBtn.classList.add('category-btn');
      if (currentCategoryID === 0 && !publicMode) {
        allLinksBtn.classList.add('active');
      }
      allLinksBtn.addEventListener('click', () => selectCategory(0, false));
      allLinksItem.appendChild(allLinksBtn);
      categoryList.appendChild(allLinksItem);

      // æ·»åŠ â€œå…¬å…±é“¾æ¥â€é€‰é¡¹
      const publicLinksItem = document.createElement('li');
      const publicLinksBtn = document.createElement('button');
      publicLinksBtn.textContent = 'å…¬å¼€é“¾æ¥';
      publicLinksBtn.dataset.id = -1; // ç”¨-1è¡¨ç¤ºå…¬å…±é“¾æ¥
      publicLinksBtn.classList.add('category-btn');
      if (publicMode) {
        publicLinksBtn.classList.add('active');
      }
      publicLinksBtn.addEventListener('click', () => selectCategory(-1, true));
      publicLinksItem.appendChild(publicLinksBtn);
      categoryList.appendChild(publicLinksItem);


      // æ¸²æŸ“å…¶ä»–åˆ†ç±»
      categories.forEach(category => {
        const li = document.createElement('li');
        li.setAttribute('draggable', true);
        li.dataset.id = category.id;
        li.dataset.sortNum = category.sort_num;

        const button = document.createElement('button');
        button.textContent = category.name + (category.is_public ? ' (å…¬å¼€)' : '');
        button.dataset.id = category.id;
        button.classList.add('category-btn');
        if (currentCategoryID === category.id && !publicMode) {
          button.classList.add('active');
        }
        button.addEventListener('click', () => selectCategory(category.id, false));

        const actionsDiv = document.createElement('div');
        actionsDiv.classList.add('category-actions');

        const editBtn = document.createElement('button');
        editBtn.textContent = 'ç¼–è¾‘';
        editBtn.classList.add('edit-btn');
        editBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // é˜»æ­¢ç‚¹å‡»åˆ†ç±»æŒ‰é’®
          openCategoryModal(category);
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'åˆ é™¤';
        deleteBtn.classList.add('delete-btn');
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteCategory(category.id);
        });

        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);

        li.appendChild(button);
        if (!publicMode) { // éå…¬å¼€æ¨¡å¼æ‰æ˜¾ç¤ºç¼–è¾‘/åˆ é™¤æŒ‰é’®
          li.appendChild(actionsDiv);
        }

        categoryList.appendChild(li);
      });
      setupCategoryDragAndDrop();
    }

    function selectCategory(id, isPublic = false) {
      currentCategoryID = id;
      publicMode = isPublic;
      const categoryTitleElement = document.getElementById('currentCategoryTitle');
      if (isPublic) {
        categoryTitleElement.textContent = 'å…¬å¼€é“¾æ¥';
      } else if (id === 0) {
        categoryTitleElement.textContent = 'æ‰€æœ‰é“¾æ¥';
      } else {
        const selectedCategory = categories.find(cat => cat.id === id);
        categoryTitleElement.textContent = selectedCategory ? selectedCategory.name : 'æ‰€æœ‰é“¾æ¥';
      }
      // æ›´æ–°åˆ†ç±»åˆ—è¡¨çš„æ¿€æ´»çŠ¶æ€
      document.querySelectorAll('.category-btn').forEach(btn => {
        if (parseInt(btn.dataset.id) === id && !isPublic) {
          btn.classList.add('active');
        } else if (parseInt(btn.dataset.id) === -1 && isPublic) {
          btn.classList.add('active');
        }
        else {
          btn.classList.remove('active');
        }
      });
      loadLinks(id, isPublic);
      renderCategories(); // é‡æ–°æ¸²æŸ“åˆ†ç±»åˆ—è¡¨ä»¥æ˜¾ç¤ºç¼–è¾‘/åˆ é™¤æŒ‰é’®çš„å¯è§æ€§
    }

    async function addCategory() {
      const nameInput = document.getElementById('newCategoryName');
      const name = nameInput.value.trim();
      if (!name) {
        alert('åˆ†ç±»åç§°ä¸èƒ½ä¸ºç©º');
        return;
      }
      try {
        const newCategory = await fetchData(`${API_BASE}categories`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({name: name, sort_num: 0, is_public: false})
        });
        categories.push(newCategory);
        nameInput.value = '';
        await loadCategories(); // é‡æ–°åŠ è½½å¹¶æ¸²æŸ“
      } catch (error) {
        console.error('æ·»åŠ åˆ†ç±»å¤±è´¥:', error);
      }
    }

    async function deleteCategory(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤åˆ†ç±»å—ï¼Ÿå…³è”çš„é“¾æ¥ä¸ä¼šè¢«åˆ é™¤ï¼Œä½†ä¼šå¤±å»åˆ†ç±»ã€‚')) return;
      try {
        await fetchData(`${API_BASE}categories?id=${id}`, {method: 'DELETE'});
        await loadCategories();
        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰åˆ†ç±»ï¼Œåˆ™åˆ‡æ¢åˆ°â€œæ‰€æœ‰é“¾æ¥â€
        if (currentCategoryID === id) {
          selectCategory(0, false);
        }
      } catch (error) {
        console.error('åˆ é™¤åˆ†ç±»å¤±è´¥:', error);
      }
    }

    // åˆ†ç±»ç¼–è¾‘æ¨¡æ€æ¡†
    const categoryModalOverlay = document.getElementById('categoryModalOverlay');
    const categoryForm = document.getElementById('categoryForm');
    const categoryIdInput = document.getElementById('categoryId');
    const categoryNameInput = document.getElementById('categoryName');
    const categoryIsPublicInput = document.getElementById('categoryIsPublic');
    const categoryModalTitle = document.getElementById('categoryModalTitle');
    const cancelCategoryModalBtn = document.getElementById('cancelCategoryModalBtn');

    function openCategoryModal(category = null) {
      if (category) {
        categoryIdInput.value = category.id;
        categoryNameInput.value = category.name;
        categoryIsPublicInput.checked = category.is_public;
        categoryModalTitle.textContent = 'ç¼–è¾‘åˆ†ç±»';
      } else {
        // ä¸æ”¯æŒç›´æ¥æ·»åŠ ï¼Œæ·»åŠ ç”¨ä¾§è¾¹æ çš„è¾“å…¥æ¡†
        return;
      }
      categoryModalOverlay.classList.add('open');
    }

    function closeCategoryModal() {
      categoryModalOverlay.classList.remove('open');
      categoryForm.reset();
    }

    categoryForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = parseInt(categoryIdInput.value);
      const name = categoryNameInput.value.trim();
      const is_public = categoryIsPublicInput.checked;

      if (!name) {
        alert('åˆ†ç±»åç§°ä¸èƒ½ä¸ºç©º');
        return;
      }

      try {
        await fetchData(`${API_BASE}categories`, {
          method: 'POST', // åç«¯POSTç”¨äºæ–°å¢æˆ–æ›´æ–°ï¼Œæ ¹æ®IDåˆ¤æ–­
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({id: id, name: name, is_public: is_public})
        });
        closeCategoryModal();
        await loadCategories(); // é‡æ–°åŠ è½½å¹¶æ¸²æŸ“åˆ†ç±»
        loadLinks(currentCategoryID, publicMode); // é‡æ–°åŠ è½½é“¾æ¥
      } catch (error) {
        console.error('ä¿å­˜åˆ†ç±»å¤±è´¥:', error);
      }
    });

    cancelCategoryModalBtn.addEventListener('click', closeCategoryModal);
    categoryModalOverlay.addEventListener('click', (e) => {
      if (e.target === categoryModalOverlay) {
        closeCategoryModal();
      }
    });

    // åˆ†ç±»æ‹–æ‹½æ’åº
    let draggedCategory = null;

    function setupCategoryDragAndDrop() {
      const categoryItems = document.querySelectorAll('#categoryList > li[draggable="true"]');
      categoryItems.forEach(item => {
        item.addEventListener('dragstart', (e) => {
          draggedCategory = item;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', item.dataset.id);
          setTimeout(() => item.classList.add('dragging'), 0);
        });

        item.addEventListener('dragenter', (e) => {
          e.preventDefault();
          item.classList.add('drag-over');
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        });

        item.addEventListener('dragleave', () => {
          item.classList.remove('drag-over');
        });

        item.addEventListener('drop', (e) => {
          e.preventDefault();
          item.classList.remove('drag-over');
          if (draggedCategory && draggedCategory !== item) {
            const draggedIndex = Array.from(categoryList.children).indexOf(draggedCategory);
            const targetIndex = Array.from(categoryList.children).indexOf(item);

            if (draggedIndex < targetIndex) {
              categoryList.insertBefore(draggedCategory, item.nextSibling);
            } else {
              categoryList.insertBefore(draggedCategory, item);
            }
            updateCategorySortOrder();
          }
        });

        item.addEventListener('dragend', () => {
          draggedCategory.classList.remove('dragging');
          document.querySelectorAll('.category-list li').forEach(el => el.classList.remove('drag-over'));
          draggedCategory = null;
        });
      });
    }

    async function updateCategorySortOrder() {
      const sortedItems = Array.from(document.querySelectorAll('#categoryList > li[draggable="true"]'));
      const sortData = sortedItems.map((item, index) => ({
        id: parseInt(item.dataset.id),
        sort_num: sortedItems.length - index // ç®€å•å€’åºï¼Œç¡®ä¿è¶Šé å‰çš„sort_numè¶Šå¤§
      }));

      try {
        await fetchData(`${API_BASE}categories/sort`, {
          method: 'PATCH',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(sortData)
        });
        console.log('åˆ†ç±»æ’åºæ›´æ–°æˆåŠŸ');
        await loadCategories(); // é‡æ–°åŠ è½½ä»¥ç¡®ä¿æ•°æ®åŒæ­¥
      } catch (error) {
        console.error('æ›´æ–°åˆ†ç±»æ’åºå¤±è´¥:', error);
      }
    }


    // --- é“¾æ¥ç®¡ç† ---
    async function loadLinks(categoryID = 0, isPublic = false) {
      let url = `${API_BASE}links`;
      const params = [];
      if (categoryID > 0) {
        params.push(`category_id=${categoryID}`);
      }
      if (isPublic) {
        params.push('public=1');
      }
      if (params.length > 0) {
        url += `?${params.join('&')}`;
      }

      links = await fetchData(url);
      filterAndRenderLinks(); // Initial render and filter
    }

    function renderLinks(filteredLinks) {
      const linksGrid = document.getElementById('linksGrid');
      linksGrid.innerHTML = '';
      if (filteredLinks.length === 0) {
        linksGrid.innerHTML = '<p style="text-align: center; color: var(--text-secondary); width: 100%;">æ²¡æœ‰æ‰¾åˆ°é“¾æ¥ã€‚</p>';
        return;
      }

      filteredLinks.forEach(link => {
        const card = document.createElement('div');
        card.classList.add('link-card');
        card.setAttribute('draggable', true);
        card.dataset.id = link.id;
        card.dataset.sortNum = link.sort_num;

        card.innerHTML = `
                    <h4>${link.title}</h4>
                    <a href="${link.url}" target="_blank" class="link-url">${link.url}</a>
                    <p>${link.description || 'æ— æè¿°'}</p>
                    <div class="actions">
                        <button class="edit-btn" data-id="${link.id}">ç¼–è¾‘</button>
                        <button class="delete-btn" data-id="${link.id}">åˆ é™¤</button>
                    </div>
                `;
        linksGrid.appendChild(card);
      });

      // ç»‘å®šç¼–è¾‘/åˆ é™¤äº‹ä»¶
      linksGrid.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const linkId = parseInt(e.target.dataset.id);
          const linkToEdit = links.find(l => l.id === linkId);
          if (linkToEdit) openLinkModal(linkToEdit);
        });
      });
      linksGrid.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const linkId = parseInt(e.target.dataset.id);
          deleteLink(linkId);
        });
      });
      setupLinkDragAndDrop();
    }

    function filterAndRenderLinks() {
      const searchInput = document.getElementById('linkSearchInput');
      const searchTerm = searchInput.value.toLowerCase();
      const filteredLinks = links.filter(link =>
        link.title.toLowerCase().includes(searchTerm) ||
        link.description.toLowerCase().includes(searchTerm)
      );
      renderLinks(filteredLinks);
    }

    // é“¾æ¥æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡†
    const linkModalOverlay = document.getElementById('linkModalOverlay');
    const linkForm = document.getElementById('linkForm');
    const linkIdInput = document.getElementById('linkId');
    const linkTitleInput = document.getElementById('linkTitle');
    const linkUrlInput = document.getElementById('linkUrl');
    const linkDescriptionInput = document.getElementById('linkDescription');
    const linkCategorySelect = document.getElementById('linkCategory');
    const linkIsPublicInput = document.getElementById('linkIsPublic');
    const linkModalTitle = document.getElementById('linkModalTitle');
    const cancelLinkModalBtn = document.getElementById('cancelLinkModalBtn');

    function openLinkModal(link = null) {
      // å¡«å……åˆ†ç±»é€‰é¡¹
      linkCategorySelect.innerHTML = '<option value="0">æ— åˆ†ç±»</option>';
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        linkCategorySelect.appendChild(option);
      });

      if (link) {
        linkIdInput.value = link.id;
        linkTitleInput.value = link.title;
        linkUrlInput.value = link.url;
        linkDescriptionInput.value = link.description;
        linkCategorySelect.value = link.category_id || 0;
        linkIsPublicInput.checked = link.is_public;
        linkModalTitle.textContent = 'ç¼–è¾‘é“¾æ¥';
      } else {
        linkIdInput.value = '';
        linkForm.reset();
        linkCategorySelect.value = currentCategoryID > 0 ? currentCategoryID : 0; // é»˜è®¤é€‰æ‹©å½“å‰åˆ†ç±»
        linkModalTitle.textContent = 'æ·»åŠ é“¾æ¥';
      }
      linkModalOverlay.classList.add('open');
    }

    function closeLinkModal() {
      linkModalOverlay.classList.remove('open');
      linkForm.reset();
    }

    linkForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = linkIdInput.value ? parseInt(linkIdInput.value) : 0;
      const title = linkTitleInput.value.trim();
      const url = linkUrlInput.value.trim();
      const description = linkDescriptionInput.value.trim();
      const category_id = parseInt(linkCategorySelect.value) || 0;
      const is_public = linkIsPublicInput.checked;

      if (!title || !url) {
        alert('æ ‡é¢˜å’ŒURLä¸èƒ½ä¸ºç©º');
        return;
      }

      const linkData = {
        id: id,
        title: title,
        url: url,
        description: description,
        category_id: category_id,
        is_public: is_public,
        sort_num: 0 // æ–°å¢æ—¶é»˜è®¤æ’åº
      };

      try {
        await fetchData(`${API_BASE}link`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(linkData)
        });
        closeLinkModal();
        await loadLinks(currentCategoryID, publicMode); // é‡æ–°åŠ è½½å¹¶æ¸²æŸ“é“¾æ¥
      } catch (error) {
        console.error('ä¿å­˜é“¾æ¥å¤±è´¥:', error);
      }
    });

    cancelLinkModalBtn.addEventListener('click', closeLinkModal);
    linkModalOverlay.addEventListener('click', (e) => {
      if (e.target === linkModalOverlay) {
        closeLinkModal();
      }
    });

    async function deleteLink(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤é“¾æ¥å—ï¼Ÿ')) return;
      try {
        await fetchData(`${API_BASE}link?id=${id}`, {method: 'DELETE'});
        await loadLinks(currentCategoryID, publicMode); // é‡æ–°åŠ è½½å¹¶æ¸²æŸ“é“¾æ¥
      } catch (error) {
        console.error('åˆ é™¤é“¾æ¥å¤±è´¥:', error);
      }
    }

    // é“¾æ¥æ‹–æ‹½æ’åº
    let draggedLink = null;
    const linksGrid = document.getElementById('linksGrid');

    function setupLinkDragAndDrop() {
      const linkCards = document.querySelectorAll('.link-card');
      linkCards.forEach(card => {
        card.addEventListener('dragstart', (e) => {
          draggedLink = card;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', card.dataset.id);
          setTimeout(() => card.classList.add('dragging'), 0);
        });

        card.addEventListener('dragenter', (e) => {
          e.preventDefault();
          if (card !== draggedLink) {
            card.classList.add('drag-over');
          }
        });

        card.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (card !== draggedLink) {
            e.dataTransfer.dropEffect = 'move';
          }
        });

        card.addEventListener('dragleave', () => {
          card.classList.remove('drag-over');
        });

        card.addEventListener('drop', (e) => {
          e.preventDefault();
          card.classList.remove('drag-over');
          if (draggedLink && draggedLink !== card) {
            const draggedIndex = Array.from(linksGrid.children).indexOf(draggedLink);
            const targetIndex = Array.from(linksGrid.children).indexOf(card);

            if (draggedIndex < targetIndex) {
              linksGrid.insertBefore(draggedLink, card.nextSibling);
            } else {
              linksGrid.insertBefore(draggedLink, card);
            }
            updateLinkSortOrder();
          }
        });

        card.addEventListener('dragend', () => {
          draggedLink.classList.remove('dragging');
          document.querySelectorAll('.link-card').forEach(el => el.classList.remove('drag-over'));
          draggedLink = null;
        });
      });
    }

    async function updateLinkSortOrder() {
      const sortedItems = Array.from(document.querySelectorAll('.link-card'));
      const sortData = sortedItems.map((item, index) => ({
        id: parseInt(item.dataset.id),
        sort_num: sortedItems.length - index // ç®€å•å€’åºï¼Œç¡®ä¿è¶Šé å‰çš„sort_numè¶Šå¤§
      }));

      try {
        await fetchData(`${API_BASE}links/sort`, {
          method: 'PATCH',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(sortData)
        });
        console.log('é“¾æ¥æ’åºæ›´æ–°æˆåŠŸ');
        await loadLinks(currentCategoryID, publicMode); // é‡æ–°åŠ è½½ä»¥ç¡®ä¿æ•°æ®åŒæ­¥
      } catch (error) {
        console.error('æ›´æ–°é“¾æ¥æ’åºå¤±è´¥:', error);
      }
    }


    // --- åˆå§‹åŒ–å’Œäº‹ä»¶ç»‘å®š ---
    document.addEventListener('DOMContentLoaded', async () => {
      // åˆå§‹åŒ–åŠ è½½æ•°æ®
      await loadCategories();
      await loadLinks(currentCategoryID, publicMode);
      renderNavigationMenu(); // æ¸²æŸ“å¯¼èˆªèœå•

      // æœç´¢è¾“å…¥æ¡†äº‹ä»¶
      document.getElementById('linkSearchInput').addEventListener('input', debounce(filterAndRenderLinks, 300));
      document.getElementById('categorySearchInput').addEventListener('input', debounce(() => {
        const searchTerm = document.getElementById('categorySearchInput').value.toLowerCase();
        document.querySelectorAll('#categoryList li[draggable="true"]').forEach(li => {
          const categoryName = li.querySelector('button').textContent.toLowerCase();
          if (categoryName.includes(searchTerm)) {
            li.style.display = '';
          } else {
            li.style.display = 'none';
          }
        });
      }, 300));


      // æ·»åŠ é“¾æ¥æŒ‰é’®
      document.getElementById('addLinkBtn').addEventListener('click', () => openLinkModal());
      // æ·»åŠ åˆ†ç±»æŒ‰é’®
      document.getElementById('addCategoryBtn').addEventListener('click', addCategory);

      // åˆå§‹é€‰æ‹©â€œæ‰€æœ‰é“¾æ¥â€
      selectCategory(0, false);
      // ç»‘å®šä¸»é¢˜è®¾ç½®æŒ‰é’®
      if (window.bindThemeButton) {
        window.bindThemeButton();
      }
    });

    // --- å¯¼èˆªèœå•æ¸²æŸ“ ---
    function renderNavigationMenu() {
      const hamburgerIcon = document.getElementById('hamburgerIcon');
      const dropdownNavMenu = document.getElementById('dropdownNavMenu');
      dropdownNavMenu.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹

      if (window.GlobalNavMenu) {
        const isLoggedIn = window.isLoggedIn ? window.isLoggedIn() : false;

        window.GlobalNavMenu.forEach(item => {
          // æ ¹æ®ç™»å½•çŠ¶æ€è¿‡æ»¤å¯¼èˆªé¡¹
          if (item.onlyWhenNotLogin && isLoggedIn) {
            return;
          }
          if (item.onlyWhenLogin && !isLoggedIn) {
            return;
          }

          const link = document.createElement('a');
          link.href = item.url;
          link.textContent = item.name;
          link.classList.add('nav-item'); // ä½¿ç”¨æ–°çš„class for dropdown items

          // å¦‚æœæ˜¯é€€å‡ºæŒ‰é’®ï¼Œä½¿ç”¨å®šä¹‰çš„å‡½æ•°
          if (item.key === 'logout') {
            link.href = 'javascript:void(0)'; // é˜²æ­¢é¡µé¢è·³è½¬
            link.addEventListener('click', (e) => {
              e.preventDefault(); // Prevent default link behavior
              if (window.logoutAndRedirect) {
                window.logoutAndRedirect();
                // Close menu after action
                dropdownNavMenu.classList.remove('open');
              }
            });
          } else {
            // For other links, close menu on click
            link.addEventListener('click', () => {
              dropdownNavMenu.classList.remove('open');
            });
          }

          dropdownNavMenu.appendChild(link);
        });
      }

      // æ±‰å ¡å›¾æ ‡ç‚¹å‡»äº‹ä»¶
      hamburgerIcon.addEventListener('click', (e) => {
        e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡åˆ°documentï¼Œç«‹å³å…³é—­
        dropdownNavMenu.classList.toggle('open');
      });

      // ç‚¹å‡»æ–‡æ¡£å…¶ä»–åœ°æ–¹å…³é—­èœå•
      document.addEventListener('click', (e) => {
        if (!hamburgerIcon.contains(e.target) && !dropdownNavMenu.contains(e.target)) {
          dropdownNavMenu.classList.remove('open');
        }
      });
    }

  </script>
</body>

</html>
