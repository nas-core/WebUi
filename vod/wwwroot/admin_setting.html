<!doctype html>
<html lang="zh">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>配置 - NasCoreTV</title>
        <script src="https://cdn.jsdmirror.com/gh/nas-core/nascore_static@main/libs/tailwindcss.min.js"></script>
        <link rel="stylesheet" href="css/styles.css" />
        <link rel="manifest" href="manifest.json" />
        <!-- Favicon -->
        <link rel="icon" href="image/logo.png" />
        <link rel="apple-touch-icon" href="image/logo-black.png" />
    </head>

    <body class="bg-gray-100 p-4">
        <div class="max-w-2xl mx-auto bg-white p-6 rounded shadow">
            <h2 class="text-2xl font-bold mb-4">NasCore_vod 配置</h2>
            <form id="vodConfigForm" class="space-y-4 pb-24">
                <!-- 增加底部内边距，防止被按钮遮挡 -->
                <fieldset class="border p-4 rounded">
                    <legend class="font-semibold">缓存设置 (cache)</legend>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="block"
                            >豆瓣最大缓存数 (douban_max)
                            <input
                                type="number"
                                name="douban_max"
                                class="input w-full border rounded px-2 py-1 mt-1"
                            />
                        </label>
                        <label class="block"
                            >豆瓣缓存过期(分钟) (douban_expire)
                            <input
                                type="number"
                                name="douban_expire"
                                class="input w-full border rounded px-2 py-1 mt-1"
                            />
                        </label>
                        <label class="block"
                            >资源站视频列表最大缓存数 (vodlist_max)
                            <input
                                type="number"
                                name="vodlist_max"
                                class="input w-full border rounded px-2 py-1 mt-1"
                            />
                        </label>
                        <label class="block"
                            >资源站视频列表缓存过期(分钟) (vodlist_expire)
                            <input
                                type="number"
                                name="vodlist_expire"
                                class="input w-full border rounded px-2 py-1 mt-1"
                            />
                        </label>
                        <label class="block"
                            >视频详情最大缓存数 (voddetail_max)
                            <input
                                type="number"
                                name="voddetail_max"
                                class="input w-full border rounded px-2 py-1 mt-1"
                            />
                        </label>
                        <label class="block"
                            >视频详情缓存过期(分钟) (voddetail_expire)
                            <input
                                type="number"
                                name="voddetail_expire"
                                class="input w-full border rounded px-2 py-1 mt-1"
                            />
                        </label>
                        <label class="block"
                            >其他缓存最大缓存数 (other_max)
                            <input
                                type="number"
                                name="other_max"
                                class="input w-full border rounded px-2 py-1 mt-1"
                            />
                        </label>
                        <label class="block"
                            >其他缓存过期(分钟) (other_expire)
                            <input
                                type="number"
                                name="other_expire"
                                class="input w-full border rounded px-2 py-1 mt-1"
                            />
                        </label>
                    </div>
                </fieldset>
                <fieldset class="border p-4 rounded">
                    <legend class="font-semibold">
                        订阅设置 (subscription)
                    </legend>
                    <div class="grid grid-cols-1 gap-4">
                        <label class="block"
                            >订阅地址 (urls, 多个用换行分隔)
                            <textarea
                                name="urls"
                                rows="3"
                                class="input w-full border rounded px-2 py-1 mt-1"
                            ></textarea>
                        </label>
                        <label class="block"
                            >自动更新周期(小时) (interval_hour)
                            <input
                                type="number"
                                name="interval_hour"
                                class="input w-full border rounded px-2 py-1 mt-1"
                            />
                        </label>
                        <label class="block"
                            >默认资源站标识 (default_selected_api_site,
                            多个用逗号分隔)
                            <input
                                type="text"
                                name="default_selected_api_site"
                                class="input w-full border rounded px-2 py-1 mt-1"
                            />
                        </label>
                    </div>
                </fieldset>
                <!-- 保存按钮移到表单外部，防止被遮挡 -->
            </form>
            <!-- 固定底部保存按钮区域 -->
            <div
                class="fixed left-0 bottom-0 w-full bg-white border-t z-50 flex justify-center py-3"
                style="box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.03)"
            >
                <button
                    type="submit"
                    form="vodConfigForm"
                    class="bg-blue-600 text-white px-6 py-2 rounded shadow"
                >
                    保存
                </button>
                <div id="msg" class="ml-4 text-green-600 self-center"></div>
            </div>
        </div>
        <script>
            // 拉取配置
            fetch("api/admin_get_set_config")
                .then((r) => r.json())
                .then((cfg) => {
                    // 兼容后端大写字段名
                    const cache = cfg.Cache || {};
                    const subscription = cfg.Subscription || {};
                    // 处理时间类型（纳秒转分钟/小时）
                    document.querySelector('[name="douban_max"]').value =
                        cache.DoubanMax || "";
                    document.querySelector('[name="douban_expire"]').value =
                        cache.DoubanExpire
                            ? Math.round(cache.DoubanExpire / 60000000000)
                            : "";
                    document.querySelector('[name="vodlist_max"]').value =
                        cache.VodlistMax || "";
                    document.querySelector('[name="vodlist_expire"]').value =
                        cache.VodlistExpire
                            ? Math.round(cache.VodlistExpire / 60000000000)
                            : "";
                    document.querySelector('[name="voddetail_max"]').value =
                        cache.VoddetailMax || "";
                    document.querySelector('[name="voddetail_expire"]').value =
                        cache.VoddetailExpire
                            ? Math.round(cache.VoddetailExpire / 60000000000)
                            : "";
                    document.querySelector('[name="other_max"]').value =
                        cache.OtherMax || "";
                    document.querySelector('[name="other_expire"]').value =
                        cache.OtherExpire
                            ? Math.round(cache.OtherExpire / 60000000000)
                            : "";
                    // subscription
                    document.querySelector('[name="urls"]').value = (
                        subscription.Urls || []
                    ).join("\n");
                    document.querySelector('[name="interval_hour"]').value =
                        subscription.IntervalHour
                            ? Math.round(
                                  subscription.IntervalHour / 3600000000000,
                              )
                            : "";
                    document.querySelector(
                        '[name="default_selected_api_site"]',
                    ).value = (subscription.DefaultSelectedAPISite || []).join(
                        ",",
                    );
                });
            // 保存
            document.getElementById("vodConfigForm").onsubmit = function (e) {
                e.preventDefault();
                const data = {
                    Cache: {
                        DoubanMax: Number(this.douban_max.value),
                        DoubanExpire:
                            Number(this.douban_expire.value) * 60000000000, // 分钟转纳秒
                        VodlistMax: Number(this.vodlist_max.value),
                        VodlistExpire:
                            Number(this.vodlist_expire.value) * 60000000000,
                        VoddetailMax: Number(this.voddetail_max.value),
                        VoddetailExpire:
                            Number(this.voddetail_expire.value) * 60000000000,
                        OtherMax: Number(this.other_max.value),
                        OtherExpire:
                            Number(this.other_expire.value) * 60000000000,
                    },
                    Subscription: {
                        Urls: this.urls.value
                            .split("\n")
                            .map((s) => s.trim())
                            .filter(Boolean),
                        IntervalHour:
                            Number(this.interval_hour.value) * 3600000000000, // 小时转纳秒
                        DefaultSelectedAPISite:
                            this.default_selected_api_site.value
                                .split(",")
                                .map((s) => s.trim())
                                .filter(Boolean),
                    },
                };
                fetch("api/admin_get_set_config", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                })
                    .then((r) => r.json())
                    .then((res) => {
                        document.getElementById("msg").innerText =
                            res.msg || "保存成功";
                    })
                    .catch(() => {
                        document.getElementById("msg").innerText = "保存失败";
                    });
            };
        </script>
    </body>
</html>
